<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¬ê³ ê´€ë¦¬ ì‹œìŠ¤í…œ 555</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'IBM Plex Sans KR', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    body { margin: 0; padding: 0; background: #f8f9fa; color: #1f2937; }
    .btn-primary { transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .submenu.open { max-height: 500px; }
    .menu-item { transition: all 0.2s; }
    .menu-item:hover { background: #f3f4f6; }
    .menu-item.active { background: #eff6ff; color: #2563eb; font-weight: 600; border-left: 3px solid #2563eb; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ë©”ë‰´ êµ¬ì¡° ì •ì˜
    const MENU_STRUCTURE = [
      {
        id: 'dashboard',
        name: 'ëŒ€ì‹œë³´ë“œ',
        icon: 'ğŸ“Š',
        items: [
          { id: 'dashboard-main', name: 'ì „ì²´ í˜„í™©' }
        ]
      },
      {
        id: 'master',
        name: 'ì •ë³´ê´€ë¦¬',
        icon: 'ğŸ“¦',
        items: [
          { id: 'vendors', name: 'ì—…ì²´ì½”ë“œ' },
          { id: 'items', name: 'í’ˆëª©ì½”ë“œ' },
          { id: 'project-manage', name: 'í”„ë¡œì íŠ¸' },
          { id: 'warehouses', name: 'ì°½ê³ ì½”ë“œ' },
          { id: 'steeltype', name: 'ê°•ì¢…ì½”ë“œ' },
          { id: 'approvers', name: 'ê²°ì¬ìê´€ë¦¬' }
        ]
      },
      {
        id: 'purchase',
        name: 'ë°œì£¼ê´€ë¦¬',
        icon: 'ğŸ“',
        items: [
          { id: 'purchase-order', name: 'ë°œì£¼ë“±ë¡' },
          { id: 'purchase-list', name: 'ë°œì£¼ë‚´ì—­' }
        ]
      },
      {
        id: 'incoming',
        name: 'ì…ê³ ê´€ë¦¬',
        icon: 'ğŸ“¥',
        items: [
          { id: 'incoming-create', name: 'ì…ê³ ë“±ë¡' },
          { id: 'incoming-list', name: 'ì…ê³ ë‚´ì—­' }
        ]
      },
      {
        id: 'outgoing',
        name: 'ì¶œê³ ê´€ë¦¬',
        icon: 'ğŸ“¤',
        items: [
          { id: 'outgoing-create', name: 'ì¶œê³ ë“±ë¡' },
          { id: 'outgoing-list', name: 'ì¶œê³ ë‚´ì—­' }
        ]
      },
      {
        id: 'transfer',
        name: 'ìì¬ì´ë™',
        icon: 'ğŸ”„',
        items: [
          { id: 'transfer-create', name: 'ì´ë™ë“±ë¡' },
          { id: 'transfer-list', name: 'ì´ë™ë‚´ì—­' }
        ]
      },
      {
        id: 'stock',
        name: 'ì¬ê³ ê´€ë¦¬',
        icon: 'ğŸ“‹',
        items: [
          { id: 'stock-current', name: 'ì¬ê³ í˜„í™©' },
          { id: 'stock-byitem', name: 'í’ˆëª©ë³„ ì¬ê³ ' },
          { id: 'stock-bywarehouse', name: 'ì°½ê³ ë³„ ì¬ê³ ' },
          { id: 'stock-byproject', name: 'í”„ë¡œì íŠ¸ë³„ ì¬ê³ ' }
        ]
      },
      {
        id: 'report',
        name: 'ë¦¬í¬íŠ¸',
        icon: 'ğŸ“Š',
        items: [
          { id: 'report-inout', name: 'ì…ì¶œê³  í˜„í™©' },
          { id: 'report-project', name: 'í”„ë¡œì íŠ¸ë³„ ì§‘ê³„' },
          { id: 'report-analysis', name: 'ì¬ê³  ë¶„ì„' }
        ]
      },
    ];

    // ========== Supabase ì´ˆê¸°í™” ==========
    const SUPABASE_URL = 'https://sfmaoxqnefwhsslzmqxm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmbWFveHFuZWZ3aHNzbHptcXhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTE5MDAsImV4cCI6MjA4NTY2NzkwMH0.U4dNBNrLAGJrH7MpUu5e3852skyGgzeCfyqM1n3sen8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========== Storage ë˜í¼ (Supabase + ìºì‹œ) ==========
    const storage = {
      cache: {},
      
      // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Supabase â†’ ìºì‹œ)
      get: async (table) => {
        // ìºì‹œì— ìˆìœ¼ë©´ ë°”ë¡œ ë¦¬í„´
        if (storage.cache[table]) {
          return storage.cache[table];
        }
        
        // Supabaseì—ì„œ ê°€ì ¸ì˜¤ê¸°
        try {
          const { data, error } = await supabase.from(table).select('*');
          if (error) throw error;
          storage.cache[table] = data || [];
          return storage.cache[table];
        } catch (err) {
          console.error(`[Supabase] ${table} ì¡°íšŒ ì‹¤íŒ¨:`, err);
          return [];
        }
      },
      
      // ë°ì´í„° ì €ì¥í•˜ê¸° (Supabase + ìºì‹œ ê°±ì‹ )
      set: async (table, data) => {
        try {
          // ê¸°ì¡´ ë°ì´í„° ì „ì²´ ì‚­ì œ
          await supabase.from(table).delete().neq('id', '');
          
          // ìƒˆ ë°ì´í„° ì‚½ì…
          if (data && data.length > 0) {
            const { error } = await supabase.from(table).insert(data);
            if (error) throw error;
          }
          
          // ìºì‹œ ê°±ì‹ 
          storage.cache[table] = data;
          return true;
        } catch (err) {
          console.error(`[Supabase] ${table} ì €ì¥ ì‹¤íŒ¨:`, err);
          return false;
        }
      },
      
      // ìºì‹œ ì´ˆê¸°í™”
      clearCache: () => {
        storage.cache = {};
      }
    };

    // ========== ê³µí†µ ìœ í‹¸ë¦¬í‹° ==========
    const fmt = {
      num: v => Number(v||0).toLocaleString(),
      date: v => v ? new Date(v).toLocaleDateString('ko-KR') : '-',
      pct: v => (Number(v||0)).toFixed(1) + '%'
    };

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function excelDown(rows, headers, filename) {
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, filename + '.xlsx');
    }

    // ì—‘ì…€ ì—…ë¡œë“œ â†’ íŒŒì‹±í•˜ì—¬ ì½œë°±
    function excelUpload(file, callback) {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result, {type:'binary'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1});
        callback(rows); // rows[0]=í—¤ë”, rows[1..]=ë°ì´í„°
      };
      reader.readAsBinaryString(file);
    }

    // PDF ë‹¤ìš´ë¡œë“œ (í…Œì´ë¸” ê¸°ë°˜)
    function pdfDown(title, headers, rows, filename) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont('Helvetica');
      doc.setFontSize(14);
      doc.text(title, 10, 15);
      doc.autoTable({
        head: [headers],
        body: rows,
        startY: 22,
        styles: { fontSize: 9, halign:'center' },
        headStyles: { fillColor: [59,130,246], textColor:255 }
      });
      doc.save(filename + '.pdf');
    }

    // í”„ë¦°íŠ¸
    function printPage(title, headers, rows) {
      const cols = headers.map((h,i) => `<th style="border:1px solid #ccc;padding:6px 10px;background:#f3f4f6;font-size:12px">${h}</th>`).join('');
      const body = rows.map(r =>
        '<tr>' + r.map(c => `<td style="border:1px solid #ccc;padding:5px 10px;font-size:12px;text-align:center">${c}</td>`).join('') + '</tr>'
      ).join('');
      const html = `
        <html><head><title>${title}</title>
        <style>body{font-family:'ë§‘ì€ê³ ë”•',sans-serif;margin:30px}
        h2{margin-bottom:12px;font-size:16px}
        table{border-collapse:collapse;width:100%}
        @media print{body{margin:10px}}</style></head>
        <body><h2>${title}</h2>
        <table><thead><tr>${cols}</tr></thead><tbody>${body}</tbody></table>
        <script>window.onload=()=>{window.print();window.close();}<\/script></body></html>`;
      const w = window.open('','_blank','width=900,height=700');
      w.document.write(html);
    }

    // ê³µí†µ Toolbar (ëª¨ë“  ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ì— ì‚¬ìš©)
    function Toolbar({ title, subtitle, onExcelDown, onPdfDown, onPrint, onExcelUpload, children }) {
      const fileRef = React.useRef(null);
      return (
        <div className="flex justify-between items-start">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{title}</h1>
            {subtitle && <p className="text-gray-500 mt-0.5 text-sm">{subtitle}</p>}
          </div>
          <div className="flex gap-2 items-center flex-wrap justify-end">
            {children}
            <button onClick={onPrint} className="px-3 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-100 flex items-center gap-1">ğŸ–¨ï¸ í”„ë¦°íŠ¸</button>
            <button onClick={() => fileRef.current && fileRef.current.click()} className="px-3 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-100 flex items-center gap-1">ğŸ“‚ ì—‘ì…€ ì—…ë¡œë“œ</button>
            <input ref={fileRef} type="file" accept=".xlsx,.xls" className="hidden" onChange={e => { if(e.target.files[0]) onExcelUpload(e.target.files[0]); e.target.value=''; }} />
            <button onClick={onExcelDown} className="px-3 py-1.5 rounded-lg border text-sm text-green-700 hover:bg-green-50 flex items-center gap-1">ğŸ“Š ì—‘ì…€ ë‹¤ìš´</button>
            <button onClick={onPdfDown} className="px-3 py-1.5 rounded-lg border text-sm text-red-700 hover:bg-red-50 flex items-center gap-1">ğŸ“„ PDF ë‹¤ìš´</button>
          </div>
        </div>
      );
    }

    // ì´ˆê¸° ë°ì´í„° (ì‹¤ì œ ì—…ë¬´ ê¸°ë°˜ ìƒ˜í”Œ 30ê°œ)
    // ì´ˆê¸° ë°ì´í„° (vendorsë§Œ Supabase ì‚¬ìš©, ë‚˜ë¨¸ì§€ëŠ” ë‚˜ì¤‘ì—)
    const initData = () => {
      // VendorsëŠ” Supabaseì—ì„œ ì§ì ‘ ë¡œë“œ
      // ë‚˜ë¨¸ì§€ í…Œì´ë¸”ì€ ë‚˜ì¤‘ì— ì¶”ê°€ ì˜ˆì •
      console.log('[Init] Vendorsë§Œ Supabase ì—°ë™ í…ŒìŠ¤íŠ¸ ì¤‘...');
    };

    function App() {
      const [currentView, setCurrentView] = useState('dashboard-main');
      const [user, setUser] = useState(null);
      const [openMenu, setOpenMenu] = useState('dashboard');

      useEffect(() => {
        initData();
        const u = storage.get('user') || { email: 'demo@example.com', name: 'ë°ëª¨ ì‚¬ìš©ì' };
        storage.set('user', u);
        setUser(u);
      }, []);

      if (!user) return <div>Loading...</div>;

      const handleMenuClick = (menuId, itemId) => {
        setOpenMenu(menuId);
        setCurrentView(itemId);
      };

      return (
        <div className="min-h-screen bg-gray-50 flex">
          {/* ì‚¬ì´ë“œë°” */}
          <div className="w-64 bg-white border-r border-gray-200 shadow-sm flex flex-col h-screen sticky top-0">
            {/* í—¤ë” */}
            <div className="p-4 border-b border-gray-200">
              <h1 className="text-xl font-bold text-blue-600 mono">STOCK.SYS v4</h1>
              <p className="text-xs text-gray-500 mt-1">ì¬ê³ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>

            {/* ë©”ë‰´ */}
            <nav className="flex-1 overflow-y-auto p-2">
              {MENU_STRUCTURE.map(menu => (
                <div key={menu.id} className="mb-1">
                  <button
                    onClick={() => setOpenMenu(openMenu === menu.id ? null : menu.id)}
                    className="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 transition"
                  >
                    <span>
                      <span className="mr-2">{menu.icon}</span>
                      {menu.name}
                    </span>
                    <span className="text-gray-400">{openMenu === menu.id ? 'â–¼' : 'â–¶'}</span>
                  </button>
                  <div className={`submenu ml-4 ${openMenu === menu.id ? 'open' : ''}`}>
                    {menu.items.map(item => (
                      <button
                        key={item.id}
                        onClick={() => handleMenuClick(menu.id, item.id)}
                        className={`w-full text-left px-3 py-2 rounded text-sm menu-item ${
                          currentView === item.id ? 'active' : 'text-gray-600'
                        }`}
                      >
                        {item.name}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </nav>

            {/* ì‚¬ìš©ì ì •ë³´ */}
            <div className="p-4 border-t border-gray-200">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
                  {user.name.charAt(0)}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-semibold text-gray-900 truncate">{user.name}</p>
                  <p className="text-xs text-gray-500 truncate">{user.email}</p>
                </div>
              </div>
            </div>
          </div>

          {/* ë©”ì¸ ì»¨í…ì¸  */}
          <div className="flex-1 overflow-auto">
            <div className="p-8">
              <ContentArea currentView={currentView} />
            </div>
          </div>
        </div>
      );
    }

    function ContentArea({ currentView }) {
      const renderContent = () => {
        switch(currentView) {
          case 'dashboard-main':  return <Dashboard />;
          case 'vendors':         return <Vendors />;
          case 'items':           return <Items />;
          case 'project-manage':  return <ProjectManage />;
          case 'warehouses':      return <Warehouses />;
          case 'steeltype':       return <SteelType />;
          case 'approvers':       return <Approvers />;
          case 'purchase-order':  return <PurchaseOrder />;
          case 'purchase-list':   return <PurchaseList />;
          case 'incoming-create': return <IncomingCreate />;
          case 'incoming-list':   return <IncomingList />;
          case 'outgoing-create': return <OutgoingCreate />;
          case 'outgoing-list':   return <OutgoingList />;
          case 'transfer-create': return <TransferCreate />;
          case 'transfer-list':   return <TransferList />;
          case 'stock-current':   return <StockCurrent />;
          case 'stock-byitem':    return <StockByItem />;
          case 'stock-bywarehouse': return <StockByWarehouse />;
          case 'stock-byproject': return <StockByProject />;
          case 'report-inout':    return <ReportInOut />;
          case 'report-project':  return <ReportProject />;
          case 'report-analysis': return <ReportAnalysis />;
          default:                return <ComingSoon viewId={currentView} />;
        }
      };
      return renderContent();
    }

    // ëŒ€ì‹œë³´ë“œ
    function Dashboard() {
      const projects = storage.get('projects') || [];
      const purchases = storage.get('purchases') || [];
      const vendors = storage.get('vendors') || [];
      
      // í™œì„± í”„ë¡œì íŠ¸
      const activeProjects = projects.filter(p => p.active);
      
      // ìµœê·¼ í•œë‹¬ ë‚´ ê²°ì¬ìš”ì²­ ê±´ + ê²°ì¬ëŒ€ê¸° ì „ì²´ (ê¸°ê°„ ìƒê´€ì—†ì´)
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      
      const recentApprovals = purchases.filter(p => {
        if (!p.requestDate) return false;
        // ê²°ì¬ëŒ€ê¸°ëŠ” ê¸°ê°„ ìƒê´€ì—†ì´ ì „ì²´
        if (p.status === 'pending') return true;
        // ê·¸ ì™¸ëŠ” ìµœê·¼ í•œë‹¬
        const reqDate = new Date(p.requestDate);
        return reqDate >= oneMonthAgo;
      }).sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
      
      // ìµœê·¼ ì†¡ê¸ˆìš”ì²­ ê±´ 10ê°œ (ì„ ìˆ˜ê¸ˆ ë˜ëŠ” ì”ê¸ˆ ì†¡ê¸ˆìš”ì²­ ìƒíƒœ)
      const recentPayments = purchases.filter(p => 
        p.status === 'advance-requested' || p.status === 'balance-requested'
      ).sort((a, b) => {
        const dateA = new Date(p.advanceRequestDate || p.balanceRequestDate || p.requestDate);
        const dateB = new Date(b.advanceRequestDate || b.balanceRequestDate || b.requestDate);
        return dateB - dateA;
      }).slice(0, 10);
      
      const getVendorName = (code) => (vendors.find(v => v.code === code) || {}).name || code;
      
      const statusBadge = (status) => {
        const map = {
          'pending': { label: 'ê²°ì¬ëŒ€ê¸°', color: 'orange' },
          'approved': { label: 'ê²°ì¬ìŠ¹ì¸', color: 'green' },
          'rejected': { label: 'ê²°ì¬ë°˜ë ¤', color: 'red' },
          'advance-requested': { label: 'ì„ ìˆ˜ê¸ˆìš”ì²­', color: 'blue' },
          'advance-paid': { label: 'ì„ ìˆ˜ê¸ˆì™„ë£Œ', color: 'indigo' },
          'balance-requested': { label: 'ì”ê¸ˆìš”ì²­', color: 'purple' },
          'completed': { label: 'ì™„ë£Œ', color: 'gray' }
        };
        const s = map[status] || { label: status, color: 'gray' };
        return <span className={`px-2 py-0.5 rounded-full text-xs font-semibold bg-${s.color}-100 text-${s.color}-700`}>{s.label}</span>;
      };
      
      const formatDate = (d) => {
        if (!d) return '-';
        const date = new Date(d);
        return `${date.getMonth()+1}/${date.getDate()}`;
      };

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</h1>
            <p className="text-gray-500 mt-1">ì£¼ìš” í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
          </div>

          {/* í™œì„± í”„ë¡œì íŠ¸ ì¹´ë“œ */}
          <div className="bg-white p-6 rounded-xl border shadow-sm">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-800">ğŸ—ï¸ í™œì„± í”„ë¡œì íŠ¸</h2>
              <span className="text-2xl font-bold text-purple-600">{activeProjects.length}ê°œ</span>
            </div>
            <div className="grid grid-cols-5 gap-3">
              {activeProjects.length === 0 && (
                <div className="col-span-5 text-center py-8 text-gray-400">í™œì„± í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              )}
              {activeProjects.map(p => (
                <div key={p.id} className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                  <div className="text-xs text-purple-600 mono font-semibold">{p.code}</div>
                  <div className="text-sm font-bold text-gray-800 mt-1">{p.name}</div>
                </div>
              ))}
            </div>
          </div>

          {/* ê²°ì¬ í˜„í™© */}
          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <div className="p-4 border-b bg-gray-50">
              <h2 className="text-lg font-bold text-gray-800">ğŸ“‹ ê²°ì¬ í˜„í™©</h2>
              <p className="text-xs text-gray-500 mt-1">ìµœê·¼ í•œë‹¬ ë‚´ ê²°ì¬ìš”ì²­ + ê²°ì¬ëŒ€ê¸° ì „ì²´</p>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ìš”ì²­ì¼</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ë°œì£¼ë²ˆí˜¸</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ì—…ì²´</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-right">ê¸ˆì•¡</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-center">ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody>
                  {recentApprovals.length === 0 && (
                    <tr><td colSpan={5} className="text-center py-8 text-gray-400 text-sm">ê²°ì¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                  )}
                  {recentApprovals.map(p => (
                    <tr key={p.id} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-3 text-sm text-gray-600">{formatDate(p.requestDate)}</td>
                      <td className="px-4 py-3 text-sm mono font-semibold text-blue-600">{p.orderNo}</td>
                      <td className="px-4 py-3 text-sm text-gray-800">{getVendorName(p.vendor)}</td>
                      <td className="px-4 py-3 text-sm text-right mono font-semibold">{(p.totalAmount || 0).toLocaleString()}</td>
                      <td className="px-4 py-3 text-center">{statusBadge(p.status)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* ìµœê·¼ ì†¡ê¸ˆìš”ì²­ */}
          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <div className="p-4 border-b bg-gray-50">
              <h2 className="text-lg font-bold text-gray-800">ğŸ’° ìµœê·¼ ì†¡ê¸ˆìš”ì²­</h2>
              <p className="text-xs text-gray-500 mt-1">ìµœê·¼ 10ê±´</p>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ìš”ì²­ì¼</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ë°œì£¼ë²ˆí˜¸</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-left">ì—…ì²´</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-center">êµ¬ë¶„</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-right">ê¸ˆì•¡</th>
                    <th className="px-4 py-2 text-xs font-semibold text-gray-600 text-center">ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody>
                  {recentPayments.length === 0 && (
                    <tr><td colSpan={6} className="text-center py-8 text-gray-400 text-sm">ì†¡ê¸ˆìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                  )}
                  {recentPayments.map(p => {
                    const isAdvance = p.status === 'advance-requested';
                    const reqDate = isAdvance ? p.advanceRequestDate : p.balanceRequestDate;
                    const amount = isAdvance ? p.advanceAmount : p.balanceAmount;
                    return (
                      <tr key={p.id} className="border-b hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-600">{formatDate(reqDate)}</td>
                        <td className="px-4 py-3 text-sm mono font-semibold text-blue-600">{p.orderNo}</td>
                        <td className="px-4 py-3 text-sm text-gray-800">{getVendorName(p.vendor)}</td>
                        <td className="px-4 py-3 text-center">
                          <span className={`px-2 py-0.5 rounded text-xs font-semibold ${isAdvance ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}`}>
                            {isAdvance ? 'ì„ ìˆ˜ê¸ˆ' : 'ì”ê¸ˆ'}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-sm text-right mono font-semibold">{(amount || 0).toLocaleString()}</td>
                        <td className="px-4 py-3 text-center">{statusBadge(p.status)}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    // ========== í’ˆëª©ì½”ë“œ ==========
    function Items() {
      const [items, setItems] = useState(storage.get('items') || []);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const steeltypes = storage.get('steeltypes') || [];
      const emptyForm = { code:'', name:'', steeltype:'', spec:'', T:0, W:0, unitWeight:0, safetyStock:0, notes:'' };
      const [formData, setFormData] = useState(emptyForm);

      // â”€â”€ Hí˜•ê°• ë‹¨ì¤‘ í…Œì´ë¸” (KS í‘œì¤€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const H_BEAM_TABLE = {
        'H-100X100': 17.2,  'H-125X125': 23.8,  'H-150X150': 31.9,
        'H-175X175': 40.1,  'H-200X200': 49.9,  'H-200X204': 50.1,
        'H-244X252': 72.4,  'H-250X250': 72.4,  'H-250X255': 79.0,
        'H-294X302': 94.0,  'H-300X300': 94.0,  'H-300X305': 97.0,
        'H-340X350': 115.0, 'H-350X350': 137.0, 'H-400X400': 172.0,
        'H-450X450': 220.0, 'H-500X500': 284.0
      };

      // â”€â”€ í’ˆëª©ì½”ë“œ ìë™ìƒì„±: ITEM-001, ITEM-002 ... â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const genCode = () => {
        let max = 0;
        items.forEach(i => {
          const m = (i.code || '').match(/^ITEM-(\d+)$/);
          if (m) { const n = parseInt(m[1], 10); if (n > max) max = n; }
        });
        return 'ITEM-' + String(max + 1).padStart(3, '0');
      };

      // â”€â”€ í¼ ì—´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const openAdd  = () => { setEditItem(null); setFormData({...emptyForm, code: genCode()}); setShowForm(true); };
      const openEdit = (item) => { setEditItem(item); setFormData({...emptyForm, ...item}); setShowForm(true); };
      const cancel   = () => { setShowForm(false); setEditItem(null); setFormData(emptyForm); };

      // â”€â”€ ë‹¨ì¤‘ ìë™ê³„ì‚° (ê°•ì¢…êµ¬ë¶„ë³„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // [í˜•ê°•] ê·œê²© â†’ Hí˜•ê°• í…Œì´ë¸” ê²€ìƒ‰ / ì—†ìœ¼ë©´ ê·¼ì‚¬ê³µì‹ / [ì² íŒ] TÃ—W ê³µì‹ / [ì¼ë°˜] ìˆ˜ê¸°
      const calcUnitWeight = (fd) => {
        // í˜•ê°• (steeltype='0')
        if (fd.steeltype === '0' && fd.spec) {
          const normalized = fd.spec.toUpperCase().replace(/\s/g, ''); // ëŒ€ë¬¸ì + ê³µë°±ì œê±°
          
          // 1) í…Œì´ë¸” ì¡°íšŒ (ì •í™•)
          if (H_BEAM_TABLE[normalized]) {
            return H_BEAM_TABLE[normalized];
          }
          
          // 2) í…Œì´ë¸”ì— ì—†ìœ¼ë©´ ê·¼ì‚¬ ê³µì‹ ì‹œë„
          // H-###x### íŒ¨í„´ íŒŒì‹±: H-200x200 â†’ H=200, B=200
          const match = normalized.match(/^H-?(\d{3,4})[XÃ—](\d{3,4})$/);
          if (match) {
            const H = parseInt(match[1]); // ë†’ì´(mm)
            const B = parseInt(match[2]); // í­(mm)
            
            // Hí˜•ê°• ê·¼ì‚¬ ê³µì‹ (ì›¹ë‘ê»˜ 8mm ê°€ì •)
            // ë‹¨ì¤‘ â‰ˆ (HÃ—2 + BÃ—2) Ã— t_web Ã— 7.85 / 1000
            // í‘œì¤€ ì›¹ë‘ê»˜: ì†Œí˜•(H<200)=6mm, ì¤‘í˜•(200â‰¤H<350)=8mm, ëŒ€í˜•(Hâ‰¥350)=10mm
            const t = H < 200 ? 6 : H < 350 ? 8 : 10;
            const approx = parseFloat(((H * 2 + B * 2) * t * 7.85 / 1000).toFixed(1));
            return approx;
          }
          
          // 3) íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ unitWeight ìœ ì§€ (ìˆ˜ê¸°ì…ë ¥)
          return fd.unitWeight;
        }
        
        // ì² íŒ (steeltype='1')
        if (fd.steeltype === '1') {
          const t = Number(fd.T)||0, w = Number(fd.W)||0;
          if (!t || !w) return 0;
          return parseFloat((t * w * 7.85 / 1000).toFixed(3));
        }
        
        // ì¼ë°˜ (steeltype='2') â†’ ìˆ˜ê¸°ì…ë ¥
        return fd.unitWeight;
      };

      // â”€â”€ ê·œê²© ë³€ê²½ ì‹œ ë‹¨ì¤‘ ìë™ê³„ì‚° íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const handleSpecChange = (val) => {
        const updated = {...formData, spec: val};
        const newWeight = calcUnitWeight(updated);
        setFormData({...updated, unitWeight: newWeight});
      };

      const handleTWChange = (field, val) => {
        const updated = {...formData, [field]: Number(val)};
        const newWeight = calcUnitWeight(updated);
        setFormData({...updated, unitWeight: newWeight});
      };

      // â”€â”€ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const handleSave = () => {
        if (!formData.name.trim())   { alert('í’ˆëª©ëª…ì€ í•„ìˆ˜í•­ëª©ì…ë‹ˆë‹¤'); return; }
        if (!formData.steeltype)     { alert('ê°•ì¢…êµ¬ë¶„ì€ í•„ìˆ˜í•­ëª©ì…ë‹ˆë‹¤'); return; }
        // ì² íŒì´ë©´ T/W í•„ìˆ˜
        if (formData.steeltype === '1') {
          if (!formData.T || !formData.W) { alert('ì² íŒì€ Tì™€ Wë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤'); return; }
        }
        // ì½”ë“œ ì¤‘ë³µ ì²´í¬
        if (!editItem && items.find(i => i.code === formData.code)) { alert('ì½”ë“œ ì¤‘ë³µ'); return; }
        
        const saved = { ...formData, unitWeight: calcUnitWeight(formData), currentStock: editItem ? editItem.currentStock : 0 };
        const newList = editItem
          ? items.map(i => i.id === editItem.id ? { ...i, ...saved } : i)
          : [...items, { id: 'I' + Date.now(), ...saved }];
        setItems(newList);
        storage.set('items', newList);
        cancel();
      };

      const handleDelete = (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const n = items.filter(i => i.id !== id);
        setItems(n); storage.set('items', n);
      };

      const catLabel = (code) => (steeltypes.find(s => s.code === code) || {}).name || code;

      // ê¸°ì¡´ ê·œê²© ë¦¬ìŠ¤íŠ¸ (ì¤‘ë³µ ì œê±°)
      const existingSpecs = [...new Set(items.map(i => i.spec).filter(s => s))];

      // Toolbar ë°ì´í„°
      const tHeaders = ['í’ˆëª©ì½”ë“œ','í’ˆëª©ëª…','ê°•ì¢…','ê·œê²©','ë‹¨ì¤‘(kg/m)','ì•ˆì „ì¬ê³ ','í˜„ì¬ê³ '];
      const tRows = items.map(i => [
        i.code, i.name, catLabel(i.steeltype), i.spec||'-',
        i.unitWeight ? i.unitWeight.toFixed(3) : '-',
        i.safetyStock||0, i.currentStock||0
      ]);

      return (
        <div className="space-y-5">
          {/* Toolbar */}
          <Toolbar
            title="í’ˆëª©ì½”ë“œ"
            subtitle="ì² íŒÂ·í˜•ê°•Â·ì¼ë°˜ í’ˆëª© ë“±ë¡ ë° ê´€ë¦¬"
            onPrint={() => printPage('í’ˆëª©ì½”ë“œ', tHeaders, tRows)}
            onExcelDown={() => excelDown(tRows, tHeaders, 'í’ˆëª©ì½”ë“œ')}
            onPdfDown={() => pdfDown('í’ˆëª©ì½”ë“œ', tHeaders, tRows, 'í’ˆëª©ì½”ë“œ')}
            onExcelUpload={() => alert('ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤')}
          >
            {!showForm && (
              <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg text-sm font-semibold btn-primary">+ ì¶”ê°€</button>
            )}
          </Toolbar>

          {/* ì¶”ê°€/ìˆ˜ì • í¼ */}
          {showForm && (
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h3 className="text-sm font-bold text-gray-700 mb-4 border-b pb-2">
                {editItem ? 'í’ˆëª©ì½”ë“œ ìˆ˜ì •' : 'í’ˆëª©ì½”ë“œ ì¶”ê°€'}
              </h3>
              
              {/* ì²« í–‰: ì½”ë“œ / í’ˆëª©ëª… / ê°•ì¢…êµ¬ë¶„ / ê·œê²© / ì•ˆì „ì¬ê³  */}
              <div className="grid grid-cols-5 gap-3">
                {/* í’ˆëª©ì½”ë“œ â€” ìë™ìƒì„± */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">í’ˆëª©ì½”ë“œ <span className="text-gray-400 font-normal">(ìë™)</span></label>
                  <input type="text" value={formData.code} readOnly
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-100 text-gray-500 mono cursor-not-allowed" />
                </div>
                {/* í’ˆëª©ëª… â€” í•„ìˆ˜ */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">í’ˆëª©ëª… <span className="text-red-500">*</span></label>
                  <input type="text" value={formData.name} placeholder="ì˜ˆ: Hí˜•ê°•200"
                    onChange={e => setFormData({...formData, name: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
                {/* ê°•ì¢…êµ¬ë¶„ â€” í•„ìˆ˜ ë“œë¡­ë‹¤ìš´ */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ê°•ì¢…êµ¬ë¶„ <span className="text-red-500">*</span></label>
                  <select value={formData.steeltype} onChange={e => setFormData({...formData, steeltype: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                    <option value="">-- ì„ íƒ --</option>
                    {steeltypes.map(s => <option key={s.code} value={s.code}>{s.name}</option>)}
                  </select>
                </div>
                {/* ê·œê²© â€” datalist (ê¸°ì¡´ ê·œê²© ë“œë¡­ë‹¤ìš´ + ìˆ˜ê¸°ì…ë ¥) */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ê·œê²©</label>
                  <input type="text" value={formData.spec} placeholder="ì˜ˆ: H-200x200"
                    list="spec-list"
                    onChange={e => handleSpecChange(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                  <datalist id="spec-list">
                    {existingSpecs.map((s, i) => <option key={i} value={s} />)}
                    {Object.keys(H_BEAM_TABLE).map((k, i) => <option key={'h'+i} value={k} />)}
                  </datalist>
                </div>
                {/* ì•ˆì „ì¬ê³  */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ì•ˆì „ì¬ê³ </label>
                  <input type="number" value={formData.safetyStock}
                    onChange={e => setFormData({...formData, safetyStock: Number(e.target.value)})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
              </div>

              {/* ê°•ì¢…ë³„ ì¶”ê°€ ì…ë ¥ í–‰ */}
              {/* ì² íŒ(1): T/W ì…ë ¥ + ë‹¨ì¤‘ ìë™ */}
              {formData.steeltype === '1' && (
                <div className="grid grid-cols-5 gap-3 mt-3">
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">T (mm) <span className="text-red-500">*</span></label>
                    <input type="number" step="0.1" value={formData.T}
                      onChange={e => handleTWChange('T', e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                  </div>
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">W (mm) <span className="text-red-500">*</span></label>
                    <input type="number" step="1" value={formData.W}
                      onChange={e => handleTWChange('W', e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                  </div>
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">ë‹¨ì¤‘ (kg/m) â€” ìë™ê³„ì‚°</label>
                    <input type="text" disabled value={calcUnitWeight(formData).toFixed(3)}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-100 text-blue-600 font-semibold mono" />
                  </div>
                  <div className="col-span-2"></div>
                </div>
              )}
              {/* í˜•ê°•(0): ë‹¨ì¤‘ ìë™ ë˜ëŠ” ìˆ˜ê¸° */}
              {formData.steeltype === '0' && (
                <div className="grid grid-cols-5 gap-3 mt-3">
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">ë‹¨ì¤‘ (kg/m)</label>
                    <input type="number" step="0.1" value={formData.unitWeight}
                      onChange={e => setFormData({...formData, unitWeight: Number(e.target.value)})}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50"
                      placeholder={formData.spec && H_BEAM_TABLE[formData.spec.toUpperCase().replace(/\s/g,'')] ? 'ìë™ê³„ì‚°ë¨' : 'ì§ì ‘ì…ë ¥'} />
                  </div>
                  <div className="col-span-4">
                    {formData.spec && H_BEAM_TABLE[formData.spec.toUpperCase().replace(/\s/g,'')] && (
                      <p className="text-xs text-green-600 mt-6">âœ… Hí˜•ê°• í…Œì´ë¸”ì—ì„œ ì •í™•ê°’ ì¡°íšŒ: {calcUnitWeight(formData)} kg/m</p>
                    )}
                    {formData.spec && !H_BEAM_TABLE[formData.spec.toUpperCase().replace(/\s/g,'')] && (
                      <p className="text-xs text-blue-600 mt-6">ğŸ“ ê·¼ì‚¬ê³µì‹ìœ¼ë¡œ ìë™ê³„ì‚°: {calcUnitWeight(formData)} kg/m (Â±10% ì˜¤ì°¨ ê°€ëŠ¥, ê²€ì¦ ê¶Œì¥)</p>
                    )}
                  </div>
                </div>
              )}
              {/* ì¼ë°˜(2): ë‹¨ì¤‘ ìˆ˜ê¸°ì…ë ¥ë§Œ */}
              {formData.steeltype === '2' && (
                <div className="grid grid-cols-5 gap-3 mt-3">
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">ë‹¨ì¤‘ (ìˆ˜ê¸°ì…ë ¥)</label>
                    <input type="number" step="0.1" value={formData.unitWeight}
                      onChange={e => setFormData({...formData, unitWeight: Number(e.target.value)})}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                  </div>
                  <div className="col-span-4"></div>
                </div>
              )}

              <div className="flex justify-end gap-2 mt-4">
                <button onClick={cancel} className="px-4 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-1.5 rounded-lg text-sm font-semibold btn-primary">ì €ì¥</button>
              </div>
            </div>
          )}

          {/* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */}
          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  {['í’ˆëª©ì½”ë“œ','í’ˆëª©ëª…','ê°•ì¢…','ê·œê²©','ë‹¨ì¤‘(kg/m)','ì•ˆì „ì¬ê³ ','í˜„ì¬ê³ ','ì‘ì—…'].map(h => (
                    <th key={h} className="px-4 py-3 text-xs font-semibold text-gray-600 border-b text-left">{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {items.length === 0 && (
                  <tr><td colSpan={8} className="text-center py-10 text-gray-400 text-sm">ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                )}
                {items.map(item => (
                  <tr key={item.id} className="border-b hover:bg-gray-50">
                    <td className="px-4 py-3 mono text-blue-600 text-sm font-semibold">{item.code}</td>
                    <td className="px-4 py-3 text-sm font-semibold text-gray-800">{item.name}</td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${
                        item.steeltype === '1' ? 'bg-blue-100 text-blue-700' :
                        item.steeltype === '0' ? 'bg-purple-100 text-purple-700' :
                        'bg-gray-100 text-gray-600'
                      }`}>{catLabel(item.steeltype)}</span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">{item.spec || '-'}</td>
                    <td className="px-4 py-3 text-right mono text-sm">{item.unitWeight ? item.unitWeight.toFixed(3) : '-'}</td>
                    <td className="px-4 py-3 text-right mono text-sm text-gray-600">{item.safetyStock || 0}</td>
                    <td className={`px-4 py-3 text-right mono text-sm font-semibold ${
                      (item.currentStock||0) < (item.safetyStock||0) ? 'text-red-600' : 'text-green-600'
                    }`}>{item.currentStock || 0}</td>
                    <td className="px-4 py-3 flex gap-3">
                      <button onClick={() => openEdit(item)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold">ìˆ˜ì •</button>
                      <button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-700 text-xs font-semibold">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ì—…ì²´ì½”ë“œ
    function Vendors() {
      const [vendors, setVendors] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const emptyForm = { code: '', name: '', tel: '', person: '', notes: '' };
      const [formData, setFormData] = useState(emptyForm);

      // â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      useEffect(() => {
        loadVendors();
      }, []);

      const loadVendors = async () => {
        setLoading(true);
        const data = await storage.get('vendors');
        setVendors(data);
        setLoading(false);
      };

      // â”€â”€ ì½”ë“œ ìë™ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const genCode = () => {
        let max = 0;
        vendors.forEach(v => {
          // 4ìë¦¬ ìˆ«ì ì½”ë“œì—ì„œ ìµœëŒ€ê°’ ì°¾ê¸° (1001, 1002...)
          const num = parseInt(v.code);
          if (!isNaN(num) && num > max) max = num;
        });
        return String(max + 1);
      };

      // â”€â”€ í¼ ì—´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const openAdd = () => {
        setEditItem(null);
        setFormData({ ...emptyForm, code: genCode() });
        setShowForm(true);
      };
      const openEdit = (item) => {
        setEditItem(item);
        setFormData({
          code: item.code,
          name: item.name,
          tel: item.tel || '',
          person: item.person || '',
          notes: item.notes || ''
        });
        setShowForm(true);
      };
      const cancel = () => { setShowForm(false); setEditItem(null); setFormData(emptyForm); };

      // â”€â”€ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const handleSave = async () => {
        if (!formData.name.trim()) { alert('ì—…ì²´ëª…ì€ í•„ìˆ˜í•­ëª©ì…ë‹ˆë‹¤'); return; }
        
        // ì½”ë“œ ì¤‘ë³µ ì²´í¬ (ì‹ ê·œë§Œ)
        if (!editItem && vendors.find(v => v.code === formData.code)) { 
          alert('ì½”ë“œê°€ ì¤‘ë³µë©ë‹ˆë‹¤'); 
          return; 
        }
        
        try {
          if (editItem) {
            // ìˆ˜ì •
            const { error } = await supabase
              .from('vendors')
              .update(formData)
              .eq('id', editItem.id);
            if (error) throw error;
          } else {
            // ì‹ ê·œ
            const { error } = await supabase
              .from('vendors')
              .insert([{ 
                id: 'V' + Date.now(), 
                ...formData, 
                active: true 
              }]);
            if (error) throw error;
          }
          
          alert(editItem ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
          cancel();
          loadVendors(); // ìƒˆë¡œê³ ì¹¨
        } catch (err) {
          console.error('[Supabase] ì €ì¥ ì‹¤íŒ¨:', err);
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
      };

      // â”€â”€ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const handleDelete = async (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
          const { error } = await supabase
            .from('vendors')
            .delete()
            .eq('id', id);
          if (error) throw error;
          
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
          loadVendors(); // ìƒˆë¡œê³ ì¹¨
        } catch (err) {
          console.error('[Supabase] ì‚­ì œ ì‹¤íŒ¨:', err);
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
      };

      // â”€â”€ Toolbar ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const tHeaders = ['ì½”ë“œ','ì—…ì²´ëª…','ì—°ë½ì²˜','ë‹´ë‹¹ì'];
      const tRows = vendors.map(v => [v.code, v.name, v.tel||'-', v.person||'-']);

      return (
        <div className="space-y-5">
          {/* Loading */}
          {loading && (
            <div className="text-center py-20 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          )}
          
          {!loading && (
            <>
              {/* Toolbar */}
              <Toolbar
                title="ì—…ì²´ì½”ë“œ"
                subtitle="í˜‘ë ¥ì—…ì²´ ì½”ë“œ ë“±ë¡ ë° ê´€ë¦¬"
                onPrint={() => printPage('ì—…ì²´ì½”ë“œ', tHeaders, tRows)}
                onExcelDown={() => excelDown(tRows, tHeaders, 'ì—…ì²´ì½”ë“œ')}
                onPdfDown={() => pdfDown('ì—…ì²´ì½”ë“œ', tHeaders, tRows, 'ì—…ì²´ì½”ë“œ')}
                onExcelUpload={() => alert('ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤')}
              >
                {!showForm && (
                  <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg text-sm font-semibold btn-primary">+ ì¶”ê°€</button>
                )}
              </Toolbar>

              {/* ì¶”ê°€ / ìˆ˜ì • í¼ */}
              {showForm && (
                <div className="bg-white p-5 rounded-xl border shadow-sm">
                  <h3 className="text-sm font-bold text-gray-700 mb-4 border-b pb-2">
                    {editItem ? 'ì—…ì²´ì½”ë“œ ìˆ˜ì •' : 'ì—…ì²´ì½”ë“œ ì¶”ê°€'}
                  </h3>
                  <div className="grid grid-cols-4 gap-4">
                    {/* ì½”ë“œ â€” ìë™ìƒì„± / ìˆ˜ì •ì‹œ disabled */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-600 mb-1">ì½”ë“œ <span className="text-gray-400 font-normal">(ìë™ìƒì„±)</span></label>
                      <input type="text" value={formData.code} readOnly
                        className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-100 text-gray-500 mono cursor-not-allowed" />
                    </div>
                    {/* ì—…ì²´ëª… â€” í•„ìˆ˜ */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-600 mb-1">ì—…ì²´ëª… <span className="text-red-500">*</span></label>
                      <input type="text" value={formData.name} placeholder="ì˜ˆ: SMS Steel"
                        onChange={e => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                    </div>
                    {/* ì—°ë½ì²˜ */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-600 mb-1">ì—°ë½ì²˜</label>
                      <input type="text" value={formData.tel} placeholder="ì˜ˆ: 051-1234-5678"
                        onChange={e => setFormData({...formData, tel: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                    </div>
                    {/* ë‹´ë‹¹ì */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-600 mb-1">ë‹´ë‹¹ì</label>
                      <input type="text" value={formData.person} placeholder="ì˜ˆ: ê¹€ì² ìˆ˜"
                        onChange={e => setFormData({...formData, person: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                    </div>
                  </div>
                  {/* ë¹„ê³  */}
                  <div className="mt-4">
                    <label className="block text-xs font-semibold text-gray-600 mb-1">ë¹„ê³ </label>
                    <textarea value={formData.notes} placeholder="ë¹„ê³  ì‚¬í•­ ì…ë ¥"
                      onChange={e => setFormData({...formData, notes: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" rows={2} />
                  </div>
                  <div className="flex justify-end gap-2 mt-4">
                    <button onClick={cancel} className="px-4 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                    <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-1.5 rounded-lg text-sm font-semibold btn-primary">ì €ì¥</button>
                  </div>
                </div>
              )}

              {/* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */}
              <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      {['ì½”ë“œ','ì—…ì²´ëª…','ì—°ë½ì²˜','ë‹´ë‹¹ì','ì‘ì—…'].map(h => (
                        <th key={h} className="px-5 py-3 text-xs font-semibold text-gray-600 border-b text-left">{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {vendors.length === 0 && (
                      <tr><td colSpan={5} className="text-center py-10 text-gray-400 text-sm">ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    )}
                    {vendors.map(v => (
                      <tr key={v.id} className="border-b hover:bg-gray-50">
                        <td className="px-5 py-3 mono text-blue-600 text-sm font-semibold">{v.code}</td>
                        <td className="px-5 py-3 text-sm font-semibold text-gray-800">{v.name}</td>
                        <td className="px-5 py-3 text-sm text-gray-600">{v.tel || '-'}</td>
                        <td className="px-5 py-3 text-sm text-gray-600">{v.person || '-'}</td>
                        <td className="px-5 py-3 flex gap-3">
                          <button onClick={() => openEdit(v)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold">ìˆ˜ì •</button>
                          <button onClick={() => handleDelete(v.id)} className="text-red-500 hover:text-red-700 text-xs font-semibold">ì‚­ì œ</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </>
          )}
        </div>
      );
    }

    // ========== ì°½ê³ ì½”ë“œ ==========
    function Warehouses() {
      const [list, setList] = useState(storage.get('warehouses') || []);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const emptyForm = { code:'', name:'', notes:'' };
      const [formData, setFormData] = useState(emptyForm);

      const openAdd  = () => { setEditItem(null); setFormData(emptyForm); setShowForm(true); };
      const openEdit = (item) => { setEditItem(item); setFormData({code:item.code, name:item.name, notes:item.notes||''}); setShowForm(true); };

      const handleSave = () => {
        if (!formData.code || !formData.name) { alert('ì½”ë“œì™€ ì°½ê³ ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        if (!editItem && list.find(w => w.code === formData.code)) { alert('ì¤‘ë³µëœ ì½”ë“œì…ë‹ˆë‹¤'); return; }
        const newList = editItem
          ? list.map(w => w.id === editItem.id ? {...w, ...formData} : w)
          : [...list, { id:'W'+Date.now(), ...formData, active:true }];
        setList(newList); storage.set('warehouses', newList); setShowForm(false);
      };

      const handleDelete = (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const n = list.filter(w => w.id !== id);
        setList(n); storage.set('warehouses', n);
      };

      return (
        <div className="space-y-5">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">ì°½ê³ ì½”ë“œ</h1>
              <p className="text-gray-500 mt-1">ì°½ê³  ë° ë³´ê´€ ì¥ì†Œ ì½”ë“œ ê´€ë¦¬</p>
            </div>
            <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold btn-primary">+ ì¶”ê°€</button>
          </div>

          {showForm && (
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h2 className="text-base font-bold text-gray-800 mb-3">{editItem ? 'ì°½ê³ ì½”ë“œ ìˆ˜ì •' : 'ì°½ê³ ì½”ë“œ ì¶”ê°€'}</h2>
              <div className="flex gap-3 items-end">
                <div className="w-40">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ì½”ë“œ</label>
                  <input type="text" value={formData.code} disabled={!!editItem}
                    onChange={e => setFormData({...formData, code:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 disabled:bg-gray-100" />
                </div>
                <div className="w-56">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ì°½ê³ ëª…</label>
                  <input type="text" value={formData.name}
                    onChange={e => setFormData({...formData, name:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
                <div className="flex-1">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ë¹„ê³ </label>
                  <input type="text" value={formData.notes}
                    onChange={e => setFormData({...formData, notes:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
                <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm btn-primary">ì €ì¥</button>
                <button onClick={() => setShowForm(false)} className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm">ì·¨ì†Œ</button>
              </div>
            </div>
          )}

          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">ì½”ë“œ</th>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">ì°½ê³ ëª…</th>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">ë¹„ê³ </th>
                  <th className="px-5 py-3 text-center text-xs font-semibold text-gray-600">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody>
                {list.map(w => (
                  <tr key={w.id} className="border-b hover:bg-gray-50">
                    <td className="px-5 py-3 mono text-blue-600 text-sm font-semibold">{w.code}</td>
                    <td className="px-5 py-3 text-sm font-semibold">{w.name}</td>
                    <td className="px-5 py-3 text-sm text-gray-500">{w.notes || '-'}</td>
                    <td className="px-5 py-3 text-center">
                      <button onClick={() => openEdit(w)} className="text-blue-600 hover:text-blue-800 mr-3 text-sm">ìˆ˜ì •</button>
                      <button onClick={() => handleDelete(w.id)} className="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ========== í”„ë¡œì íŠ¸ ==========
    function ProjectManage() {
      const [list, setList] = useState(storage.get('projects') || []);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const emptyForm = { code:'', name:'', notes:'' };
      const [formData, setFormData] = useState(emptyForm);

      const openAdd  = () => { setEditItem(null); setFormData(emptyForm); setShowForm(true); };
      const openEdit = (item) => { setEditItem(item); setFormData({code:item.code, name:item.name, notes:item.notes||''}); setShowForm(true); };

      const handleSave = () => {
        if (!formData.code || !formData.name) { alert('í”„ë¡œì íŠ¸ì½”ë“œì™€ í˜¸ì„ ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        if (!editItem && list.find(p => p.code === formData.code)) { alert('ì¤‘ë³µëœ ì½”ë“œì…ë‹ˆë‹¤'); return; }
        const newList = editItem
          ? list.map(p => p.id === editItem.id ? {...p, ...formData} : p)
          : [...list, { id:'P'+Date.now(), ...formData, active:true }];
        setList(newList); storage.set('projects', newList); setShowForm(false);
      };

      const handleDelete = (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const n = list.filter(p => p.id !== id);
        setList(n); storage.set('projects', n);
      };

      const toggleActive = (id) => {
        const n = list.map(p => p.id === id ? {...p, active:!p.active} : p);
        setList(n); storage.set('projects', n);
      };

      return (
        <div className="space-y-5">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">í”„ë¡œì íŠ¸</h1>
              <p className="text-gray-500 mt-1">í˜¸ì„ ë³„ í”„ë¡œì íŠ¸ ë“±ë¡ ë° ê´€ë¦¬</p>
            </div>
            <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold btn-primary">+ ì¶”ê°€</button>
          </div>

          {showForm && (
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h2 className="text-base font-bold text-gray-800 mb-3">{editItem ? 'í”„ë¡œì íŠ¸ ìˆ˜ì •' : 'í”„ë¡œì íŠ¸ ì¶”ê°€'}</h2>
              <div className="flex gap-3 items-end">
                <div className="w-44">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">í”„ë¡œì íŠ¸ì½”ë“œ</label>
                  <input type="text" value={formData.code} disabled={!!editItem}
                    onChange={e => setFormData({...formData, code:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 disabled:bg-gray-100" placeholder="S-2025-001" />
                </div>
                <div className="w-56">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">í˜¸ì„ ëª…</label>
                  <input type="text" value={formData.name}
                    onChange={e => setFormData({...formData, name:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" placeholder="Aí˜¸ì„ " />
                </div>
                <div className="flex-1">
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ë¹„ê³ </label>
                  <input type="text" value={formData.notes}
                    onChange={e => setFormData({...formData, notes:e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
                <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm btn-primary">ì €ì¥</button>
                <button onClick={() => setShowForm(false)} className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm">ì·¨ì†Œ</button>
              </div>
            </div>
          )}

          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">í”„ë¡œì íŠ¸ì½”ë“œ</th>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">í˜¸ì„ ëª…</th>
                  <th className="px-5 py-3 text-left text-xs font-semibold text-gray-600">ë¹„ê³ </th>
                  <th className="px-5 py-3 text-center text-xs font-semibold text-gray-600">ìƒíƒœ</th>
                  <th className="px-5 py-3 text-center text-xs font-semibold text-gray-600">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody>
                {list.map(p => (
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="px-5 py-3 mono text-blue-600 text-sm font-semibold">{p.code}</td>
                    <td className="px-5 py-3 text-sm font-semibold">{p.name}</td>
                    <td className="px-5 py-3 text-sm text-gray-500">{p.notes || '-'}</td>
                    <td className="px-5 py-3 text-center">
                      <button onClick={() => toggleActive(p.id)}
                        className={`px-3 py-0.5 rounded-full text-xs font-semibold transition ${
                          p.active ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                        }`}>{p.active ? 'ì§„í–‰ì¤‘' : 'ì™„ë£Œ'}</button>
                    </td>
                    <td className="px-5 py-3 text-center">
                      <button onClick={() => openEdit(p)} className="text-blue-600 hover:text-blue-800 mr-3 text-sm">ìˆ˜ì •</button>
                      <button onClick={() => handleDelete(p.id)} className="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ë‚˜ë¨¸ì§€ ë¹ˆ í™”ë©´ë“¤
    // ==================== ê°•ì¢…ì½”ë“œ ====================
    function SteelType() {
      const [steeltypes, setSteeltypes] = useState(storage.get('steeltypes') || []);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const [formData, setFormData] = useState({ code: '', name: '' });

      const openAdd = () => { setEditItem(null); setFormData({ code: '', name: '' }); setShowForm(true); };
      const openEdit = (item) => { setEditItem(item); setFormData({ code: item.code, name: item.name }); setShowForm(true); };

      const handleSave = () => {
        if (!formData.code || !formData.name) { alert('ì½”ë“œì™€ ëª…ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        if (!editItem && steeltypes.find(s => s.code === formData.code)) { alert('ì¤‘ë³µëœ ì½”ë“œì…ë‹ˆë‹¤'); return; }
        let newList;
        if (editItem) {
          newList = steeltypes.map(s => s.id === editItem.id ? { ...s, ...formData } : s);
        } else {
          newList = [...steeltypes, { id: 'ST' + Date.now(), ...formData }];
        }
        setSteeltypes(newList);
        storage.set('steeltypes', newList);
        setShowForm(false);
      };

      const handleDelete = (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const newList = steeltypes.filter(s => s.id !== id);
        setSteeltypes(newList);
        storage.set('steeltypes', newList);
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">ê°•ì¢…ì½”ë“œ</h1>
              <p className="text-gray-500 mt-1">í˜•ê°• / ì² íŒ / ì¼ë°˜ ë“± ê°•ì¢… êµ¬ë¶„ ì½”ë“œ ê´€ë¦¬</p>
            </div>
            <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold btn-primary">+ ì¶”ê°€</button>
          </div>

          {showForm && (
            <div className="bg-white p-6 rounded-xl border shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4">{editItem ? 'ê°•ì¢…ì½”ë“œ ìˆ˜ì •' : 'ê°•ì¢…ì½”ë“œ ì¶”ê°€'}</h2>
              <div className="flex gap-4 items-end">
                <div className="flex-1">
                  <label className="block text-sm font-semibold text-gray-700 mb-1">ì½”ë“œ</label>
                  <input type="text" value={formData.code} onChange={e => setFormData({...formData, code: e.target.value})}
                    disabled={!!editItem} className="w-full px-4 py-2 border rounded-lg bg-gray-50 disabled:bg-gray-100" placeholder="ì˜ˆ: 0, 1, 2" />
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-semibold text-gray-700 mb-1">ëª…ì¹­</label>
                  <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}
                    className="w-full px-4 py-2 border rounded-lg bg-gray-50" placeholder="ì˜ˆ: í˜•ê°•" />
                </div>
                <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg btn-primary">ì €ì¥</button>
                <button onClick={() => setShowForm(false)} className="bg-gray-200 hover:bg-gray-300 px-5 py-2 rounded-lg">ì·¨ì†Œ</button>
              </div>
            </div>
          )}

          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-6 py-3 text-left text-sm font-semibold text-gray-700">ì½”ë“œ</th>
                  <th className="px-6 py-3 text-left text-sm font-semibold text-gray-700">ëª…ì¹­</th>
                  <th className="px-6 py-3 text-center text-sm font-semibold text-gray-700">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody>
                {steeltypes.map(s => (
                  <tr key={s.id} className="border-b hover:bg-gray-50">
                    <td className="px-6 py-3 mono text-blue-600 font-semibold">{s.code}</td>
                    <td className="px-6 py-3">
                      <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                        s.name === 'í˜•ê°•' ? 'bg-purple-50 text-purple-600' :
                        s.name === 'ì² íŒ' ? 'bg-blue-50 text-blue-600' :
                        'bg-gray-100 text-gray-600'
                      }`}>{s.name}</span>
                    </td>
                    <td className="px-6 py-3 text-center">
                      <button onClick={() => openEdit(s)} className="text-blue-600 hover:text-blue-800 mr-4 text-sm">ìˆ˜ì •</button>
                      <button onClick={() => handleDelete(s.id)} className="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ========== ê²°ì¬ìê´€ë¦¬ ==========
    function Approvers() {
      // ì´ˆê¸° ìƒ˜í”Œ ë°ì´í„°
      const initData = () => {
        const existing = storage.get('approvers');
        if (existing) return existing;
        const samples = [
          { id: 'APR001', role: 'approver',  name: 'Kris',  email: 'khwun@sms-sme.com' },
          { id: 'APR002', role: 'payment',   name: 'Mandy', email: 'accounting@sms-sme.com' }
        ];
        storage.set('approvers', samples);
        return samples;
      };

      const [list, setList]         = useState(initData);
      const [showForm, setShowForm] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const emptyForm = { role: 'approver', name: '', email: '' };
      const [form, setForm]         = useState(emptyForm);

      const save = (list) => { setList(list); storage.set('approvers', list); };

      const openAdd  = () => { setEditItem(null); setForm(emptyForm); setShowForm(true); };
      const openEdit = (item) => { setEditItem(item); setForm({ role: item.role, name: item.name, email: item.email }); setShowForm(true); };
      const cancel   = () => { setShowForm(false); setEditItem(null); setForm(emptyForm); };

      const handleSave = () => {
        if (!form.name.trim())  { alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        if (!form.email.trim()) { alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ (ìì‹  ì œì™¸)
        if (list.some(a => a.email === form.email && (!editItem || a.id !== editItem.id))) {
          alert('ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤'); return;
        }
        if (editItem) {
          save(list.map(a => a.id === editItem.id ? { ...a, ...form } : a));
        } else {
          const newId = 'APR' + String(list.length + 1).padStart(3, '0');
          save([...list, { id: newId, ...form }]);
        }
        cancel();
      };

      const handleDelete = (id) => {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        save(list.filter(a => a.id !== id));
      };

      // í…Œì´ë¸” ë°ì´í„°
      const roleLabel = r => r === 'approver' ? 'ê²°ì¬ì' : 'ì†¡ê¸ˆìš”ì²­ì';
      const tHeaders  = ['êµ¬ë¶„', 'ì´ë¦„', 'íšŒì‚¬ì´ë©”ì¼'];
      const tRows     = list.map(a => [roleLabel(a.role), a.name, a.email]);

      return (
        <div className="space-y-5">
          {/* Toolbar */}
          <Toolbar
            title="ê²°ì¬ìê´€ë¦¬"
            subtitle="ê²°ì¬ì ë° ì†¡ê¸ˆìš”ì²­ì ë“±ë¡"
            onPrint={() => printPage('ê²°ì¬ìê´€ë¦¬', tHeaders, tRows)}
            onExcelDown={() => excelDown(tRows, tHeaders, 'ê²°ì¬ìê´€ë¦¬')}
            onPdfDown={() => pdfDown('ê²°ì¬ìê´€ë¦¬', tHeaders, tRows, 'ê²°ì¬ìê´€ë¦¬')}
            onExcelUpload={() => alert('ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤')}
          >
            {!showForm && (
              <button onClick={openAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg text-sm font-semibold btn-primary">+ ì¶”ê°€</button>
            )}
          </Toolbar>

          {/* ì—­í•  ì•ˆë‚´ */}
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 flex items-start gap-3">
              <span className="text-lg">âœ‰ï¸</span>
              <div>
                <p className="text-sm font-semibold text-blue-700">ê²°ì¬ì</p>
                <p className="text-xs text-blue-500">ë°œì£¼ ë“±ë¡ í›„ ê²°ì¬ìš”ì²­ ì‹œ ì´ë©”ì¼ ìˆ˜ì‹  â†’ ìŠ¹ë‚™/ë°˜ê¸°</p>
              </div>
            </div>
            <div className="bg-indigo-50 border border-indigo-200 rounded-lg px-4 py-3 flex items-start gap-3">
              <span className="text-lg">ğŸ¦</span>
              <div>
                <p className="text-sm font-semibold text-indigo-700">ì†¡ê¸ˆìš”ì²­ì</p>
                <p className="text-xs text-indigo-500">ì„ ìˆ˜ê¸ˆ ì§€ê¸‰Â·ì”ê¸ˆ ì†¡ê¸ˆ ìš”ì²­ ì‹œ íšŒê³„íŒ€ ì´ë©”ì¼ ìˆ˜ì‹ </p>
              </div>
            </div>
          </div>

          {/* ì¶”ê°€/ìˆ˜ì • í¼ */}
          {showForm && (
            <div className="bg-white p-5 rounded-xl border shadow-sm animate-slide-in">
              <h3 className="text-sm font-bold text-gray-700 mb-4 border-b pb-2">
                {editItem ? 'ìˆ˜ì •' : 'ì¶”ê°€'} â€” ê²°ì¬ì ì •ë³´
              </h3>
              <div className="grid grid-cols-3 gap-4">
                {/* êµ¬ë¶„ ë“œë¡­ë‹¤ìš´ */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">êµ¬ë¶„ <span className="text-red-500">*</span></label>
                  <select value={form.role} onChange={e => setForm({...form, role: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                    <option value="approver">ê²°ì¬ì</option>
                    <option value="payment">ì†¡ê¸ˆìš”ì²­ì</option>
                  </select>
                </div>
                {/* ì´ë¦„ */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">ì´ë¦„ <span className="text-red-500">*</span></label>
                  <input type="text" value={form.name} placeholder="ì˜ˆ: Kris"
                    onChange={e => setForm({...form, name: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
                {/* íšŒì‚¬ ì´ë©”ì¼ */}
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">íšŒì‚¬ ì´ë©”ì¼ <span className="text-red-500">*</span></label>
                  <input type="email" value={form.email} placeholder="ì˜ˆ: name@company.com"
                    onChange={e => setForm({...form, email: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
                </div>
              </div>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={cancel} className="px-4 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-1.5 rounded-lg text-sm font-semibold btn-primary">
                  {editItem ? 'ì €ì¥' : 'ì¶”ê°€'}
                </button>
              </div>
            </div>
          )}

          {/* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */}
          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  {['êµ¬ë¶„','ì´ë¦„','íšŒì‚¬ ì´ë©”ì¼','ì‘ì—…'].map(h => (
                    <th key={h} className="px-5 py-3 text-xs font-semibold text-gray-600 border-b text-left">{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {list.length === 0 && (
                  <tr><td colSpan={4} className="text-center py-10 text-gray-400 text-sm">ë“±ë¡ëœ ê²°ì¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                )}
                {list.map(a => (
                  <tr key={a.id} className="border-b hover:bg-gray-50">
                    <td className="px-5 py-3">
                      <span className={`inline-block px-2.5 py-0.5 rounded-full text-xs font-semibold ${a.role === 'approver' ? 'bg-blue-100 text-blue-700' : 'bg-indigo-100 text-indigo-700'}`}>
                        {roleLabel(a.role)}
                      </span>
                    </td>
                    <td className="px-5 py-3 text-sm font-semibold text-gray-800">{a.name}</td>
                    <td className="px-5 py-3 text-sm text-gray-600 mono">{a.email}</td>
                    <td className="px-5 py-3 flex gap-3">
                      <button onClick={() => openEdit(a)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold">ìˆ˜ì •</button>
                      <button onClick={() => handleDelete(a.id)} className="text-red-500 hover:text-red-700 text-xs font-semibold">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ========== ë°œì£¼ë“±ë¡ ==========
    function PurchaseOrder() {
      const vendors    = storage.get('vendors')    || [];
      const items      = storage.get('items')      || [];
      const steeltypes = storage.get('steeltypes') || [];
      const projects   = storage.get('projects')   || [];
      const warehouses = storage.get('warehouses') || [];

      const emptyHeader = { vendor:'', steeltype:'', deliveryPlace:'', notes:'' };
      const [header, setHeader]   = useState(emptyHeader);
      const emptyLine = { itemCode:'', itemName:'', spec:'', project:'', T:0, W:0, L:0, qty:0, weight:0, unitPrice:0, amount:0, notes:'' };
      const [lines, setLines]     = useState([{...emptyLine}]);
      const [advance, setAdvance] = useState({ use: false, rate: 30 });
      const [approver, setApprover] = useState('');  // ê²°ì¬ì ì´ë©”ì¼ (Phase2ì—ì„œ ì‹¤ì œ ì‚¬ìš©)
      const [saved, setSaved]     = useState(null);  // ì €ì¥ ì™„ë£Œ í›„ í‘œì‹œ
      const [attachments, setAttachments] = useState({ invoice: null, invoiceName: '', contract: null, contractName: '' });

      // í’ˆëª© ì„ íƒ ì‹œ ìë™ì±„ìš°ê¸°
      const pickItem = (idx, code) => {
        const item = items.find(i => i.code === code);
        if (!item) { updateLine(idx, 'itemCode', code); return; }
        const updated = [...lines];
        updated[idx] = {
          ...updated[idx],
          itemCode: item.code,
          itemName: item.name,
          spec: item.spec || '',
          T: item.T || 0,
          W: item.W || 0,
          unitPrice: 0, qty: 0, weight: 0, amount: 0
        };
        setLines(updated);
      };

      const updateLine = (idx, field, val) => {
        const updated = [...lines];
        updated[idx] = { ...updated[idx], [field]: field === 'itemCode' ? val : Number(val) || val };
        const l = updated[idx];
        // ì¤‘ëŸ‰ ìë™ê³„ì‚°: ì² íŒ ê³µì‹  ë‹¨ì¤‘(kg/m) = TÃ—WÃ—7.85/1000,  ì´ì¤‘ëŸ‰ = ë‹¨ì¤‘ Ã— L/1000 Ã— ìˆ˜ëŸ‰
        if (['T','W','L','qty'].includes(field)) {
          const t = Number(l.T)||0, w = Number(l.W)||0, len = Number(l.L)||0, q = Number(l.qty)||0;
          l.weight = (t && w && len && q) ? parseFloat((t * w * 7.85 / 1000 * len / 1000 * q).toFixed(2)) : 0;
        }
        // ê¸ˆì•¡ ì¬ê³„ì‚°
        if (['qty','unitPrice'].includes(field)) {
          l.amount = (Number(l.qty)||0) * (Number(l.unitPrice)||0);
        }
        setLines(updated);
      };

      const addLine    = () => setLines([...lines, {...emptyLine}]);
      const removeLine = (idx) => setLines(lines.filter((_,i) => i !== idx));

      // í•©ê³„ ê³„ì‚°
      const totalAmt   = lines.reduce((s,l) => s + (Number(l.amount)||0), 0);
      const advanceAmt = advance.use ? Math.round(totalAmt * advance.rate / 100) : 0;

      const handleSave = () => {
        if (!header.vendor) { alert('ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
        // ìœ íš¨ í–‰ íŒë‹¨: í’ˆë²ˆ ìˆê±°ë‚˜, T/W/L ì¤‘ í•˜ë‚˜ë¼ë„ ìˆê±°ë‚˜, ìˆ˜ëŸ‰>0ì¸ í–‰
        const validLines = lines.filter(l =>
          l.itemCode || l.T || l.W || l.L || Number(l.qty) > 0
        );
        if (validLines.length === 0) { alert('í’ˆëª©ì„ ìµœì†Œ 1ê±´ ì…ë ¥í•˜ì„¸ìš”'); return; }
        const purchases = storage.get('purchases') || [];
        const no = 'ORD-' + String(purchases.length + 1).padStart(6,'0');
        const rec = {
          id: no,
          date: new Date().toISOString(),
          ...header,
          lines: validLines,
          totalAmt,
          advance: { use: advance.use, rate: advance.rate, amount: advanceAmt },
          approver,
          attachments: {
            invoice: attachments.invoice || null,
            invoiceName: attachments.invoiceName || '',
            contract: attachments.contract || null,
            contractName: attachments.contractName || ''
          },
          status: 'registered',
          approvalStatus: 'none',
          paymentStatus: 'none',
          balancePaymentStatus: 'none',
          approvalComment: '',
          approvalDate: null,
          approvalRequestDate: null,
          paymentRequestDate: null,
          paymentCompleteDate: null,
          balanceRequestDate: null,
          balanceCompleteDate: null
        };
        purchases.push(rec);
        storage.set('purchases', purchases);
        setSaved(rec);
      };

      if (saved) {
        return (
          <div className="space-y-5">
            <div className="bg-green-50 border border-green-200 rounded-xl p-8 text-center">
              <div className="text-5xl mb-3">âœ…</div>
              <h2 className="text-xl font-bold text-green-700 mb-1">ë°œì£¼ë“±ë¡ ì™„ë£Œ</h2>
              <p className="text-gray-600 mono">{saved.id}</p>
              <div className="mt-4 text-sm text-gray-500">
                ì—…ì²´: {(vendors.find(v=>v.id===saved.vendor)||{}).name || saved.vendor} &nbsp;|&nbsp;
                ê¸ˆì•¡: {fmt.num(saved.totalAmt)}ì›
                {saved.advance.use && <span> &nbsp;|&nbsp; ì„ ìˆ˜ê¸ˆ: {fmt.num(saved.advance.amount)}ì› ({saved.advance.rate}%)</span>}
              </div>
            </div>
            <div className="flex justify-center gap-3">
              <button onClick={() => { setSaved(null); setHeader(emptyHeader); setLines([{...emptyLine}]); setAdvance({use:false,rate:30}); setApprover(''); setAttachments({invoice:null,invoiceName:'',contract:null,contractName:''}); }}
                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg btn-primary">+ ì‹ ê·œ ë°œì£¼</button>
              <button onClick={() => { setSaved(null); }}
                className="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg">ë°œì£¼ë‚´ì—­ìœ¼ë¡œ</button>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-5">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">ë°œì£¼ë“±ë¡</h1>
            <p className="text-gray-500 mt-0.5 text-sm">ì›ìì¬ ë°œì£¼ ë“±ë¡ ë° ì„ ìˆ˜ê¸ˆÂ·ê²°ì¬ ìš”ì²­</p>
          </div>

          {/* í—¤ë” ì •ë³´ */}
          <div className="bg-white p-5 rounded-xl border shadow-sm">
            <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">ë°œì£¼ ê¸°ë³¸ì •ë³´</h3>
            <div className="grid grid-cols-4 gap-4">
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">ì—…ì²´</label>
                <select value={header.vendor} onChange={e => setHeader({...header, vendor:e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                  <option value="">-- ì„ íƒ --</option>
                  {vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">ê°•ì¢…êµ¬ë¶„</label>
                <select value={header.steeltype} onChange={e => setHeader({...header, steeltype:e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                  <option value="">-- ì„ íƒ --</option>
                  {steeltypes.map(s => <option key={s.code} value={s.code}>{s.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">ë‚©í’ˆì¥ì†Œ</label>
                <select value={header.deliveryPlace} onChange={e => setHeader({...header, deliveryPlace:e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                  <option value="">-- ì„ íƒ --</option>
                  {warehouses.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">ë¹„ê³ </label>
                <input type="text" value={header.notes} onChange={e => setHeader({...header, notes:e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50" />
              </div>
            </div>
          </div>

          {/* í’ˆëª©í–‰ í…Œì´ë¸” */}
          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <div className="px-5 py-3 border-b flex justify-between items-center">
              <h3 className="text-sm font-bold text-gray-700">í’ˆëª©ë‚´ì—­</h3>
              <div className="flex items-center gap-3">
                {/* ì—‘ì…€ ì—…ë¡œë“œ */}
                <label className="cursor-pointer">
                  <span className="inline-flex items-center gap-1.5 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-xs font-semibold transition">
                    ğŸ“‚ ì—‘ì…€ ì—…ë¡œë“œ
                  </span>
                  <input type="file" accept=".xlsx,.xls" className="hidden" onChange={e => {
                    if (!e.target.files[0]) return;
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = ev => {
                      const wb = XLSX.read(ev.target.result, {type:'array'});
                      const ws = wb.Sheets[wb.SheetNames[0]];
                      const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
                      // row[0] = í—¤ë”í–‰ ê±´ë„ˆë›°ê¸°, row[1]ë¶€í„° ë°ì´í„°
                      // ì»¬ëŸ¼ ë§¤í•‘ (ìƒ˜í”Œ ì—‘ì…€ ê¸°ì¤€):
                      // A(0):Project No, B(1):ì¬ì§ˆ, C(2):T, D(3):W, E(4):L,
                      // F(5):ìˆ˜ëŸ‰, G(6):ì¤‘ëŸ‰, H(7):NID NO, I(8):ë‹¨ê°€, J(9):ì°©ì§€, K(10):ë¹„ê³ 
                      const parsed = [];
                      for (let i = 1; i < rows.length; i++) {
                        const r = rows[i];
                        if (!r || r.length < 3) continue;
                        const projName = String(r[0] || '').trim();
                        const matchProj = projects.find(p => p.name === projName || p.id === projName);
                        const qty   = Number(r[5]) || 0;
                        const price = Number(r[8]) || 0;
                        const t     = Number(r[2]) || 0;
                        const w     = Number(r[3]) || 0;
                        const len   = Number(r[4]) || 0;
                        // ì² íŒ ì¤‘ëŸ‰ ê³µì‹: TÃ—WÃ—7.85/1000 (ë‹¨ì¤‘ kg/m) Ã— L/1000 (ê¸¸ì´ m) Ã— ìˆ˜ëŸ‰
                        const calcW = (t && w && len && qty) ? parseFloat((t * w * 7.85 / 1000 * len / 1000 * qty).toFixed(2)) : 0;
                        parsed.push({
                          itemCode: '',
                          itemName: String(r[1] || ''),
                          spec: '',
                          project: matchProj ? matchProj.id : '',
                          projectRaw: projName,
                          T: t,
                          W: w,
                          L: len,
                          qty: qty,
                          weight: calcW,
                          unitPrice: price,
                          amount: qty * price,
                          notes: String(r[10] || '')
                        });
                      }
                      if (parsed.length > 0) {
                        setLines(parsed);
                        alert(parsed.length + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ!\në‹¨ê°€ê°€ ì—†ëŠ” í–‰ì€ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.');
                      } else {
                        alert('ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
                      }
                    };
                    reader.readAsArrayBuffer(file);
                    e.target.value = '';
                  }} />
                </label>
                <button onClick={addLine} className="text-blue-600 hover:text-blue-800 text-sm font-semibold">+ í–‰ ì¶”ê°€</button>
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    {['í’ˆë²ˆ','í’ˆëª…','ê·œê²©','í”„ë¡œì íŠ¸','T','W','L','ìˆ˜ëŸ‰','ì¤‘ëŸ‰','ë‹¨ê°€','ê¸ˆì•¡','ë¹„ê³ ','ì‚­ì œ'].map(h => (
                      <th key={h} className="px-2 py-2 text-xs font-semibold text-gray-600 border-b whitespace-nowrap">{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {lines.map((l, idx) => (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="px-1 py-1">
                        <select value={l.itemCode} onChange={e => pickItem(idx, e.target.value)}
                          className="w-24 px-1 py-1 border rounded text-xs bg-gray-50">
                          <option value="">ì„ íƒ</option>
                          {items.map(i => <option key={i.code} value={i.code}>{i.code}</option>)}
                        </select>
                      </td>
                      <td className="px-2 py-1 text-xs text-gray-600 whitespace-nowrap">{l.itemName || '-'}</td>
                      <td className="px-2 py-1 text-xs text-gray-500">{l.spec || '-'}</td>
                      <td className="px-1 py-1">
                        <select value={l.project} onChange={e => updateLine(idx,'project',e.target.value)}
                          className="w-24 px-1 py-1 border rounded text-xs bg-gray-50">
                          <option value="">-</option>
                          {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                        {/* ì—‘ì…€ì—ì„œ ì˜¬ë¼ì˜¨ í”„ë¡œì íŠ¸ëª…ì´ ë§¤ì¹­ì•ˆë˜ë©´ ì›ë³¸ê°’ í‘œì‹œ */}
                        {l.projectRaw && !l.project && (
                          <p className="text-xs text-orange-500 mt-0.5 truncate w-24" title={l.projectRaw}>âš ï¸ {l.projectRaw}</p>
                        )}
                      </td>
                      {['T','W','L'].map(f => (
                        <td key={f} className="px-1 py-1">
                          <input type="number" step="0.1" value={l[f]} onChange={e => updateLine(idx,f,e.target.value)}
                            className="w-14 px-1 py-1 border rounded text-xs text-right bg-gray-50" />
                        </td>
                      ))}
                      <td className="px-1 py-1">
                        <input type="number" value={l.qty} onChange={e => updateLine(idx,'qty',e.target.value)}
                          className="w-16 px-1 py-1 border rounded text-xs text-right bg-gray-50" />
                      </td>
                      <td className="px-2 py-1 text-xs text-right mono text-gray-500">{fmt.num(l.weight)}</td>
                      <td className="px-1 py-1">
                        <input type="number" value={l.unitPrice} onChange={e => updateLine(idx,'unitPrice',e.target.value)}
                          className="w-20 px-1 py-1 border rounded text-xs text-right bg-gray-50" />
                      </td>
                      <td className="px-2 py-1 text-xs text-right mono font-semibold text-blue-600">{fmt.num(l.amount)}</td>
                      <td className="px-1 py-1">
                        <input type="text" value={l.notes} onChange={e => updateLine(idx,'notes',e.target.value)}
                          className="w-20 px-1 py-1 border rounded text-xs bg-gray-50" />
                      </td>
                      <td className="px-2 py-1 text-center">
                        <button onClick={() => removeLine(idx)} className="text-red-400 hover:text-red-600 text-xs">âœ•</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* ì„ ìˆ˜ê¸ˆ + ê²°ì¬ì + í•©ê³„ */}
          <div className="grid grid-cols-3 gap-4">
            {/* ì„ ìˆ˜ê¸ˆ ì„¤ì • */}
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">ì„ ìˆ˜ê¸ˆ ì„¤ì •</h3>
              <div className="flex items-center gap-3 mb-3">
                <label className="flex items-center gap-2 text-sm cursor-pointer">
                  <input type="checkbox" checked={advance.use} onChange={e => setAdvance({...advance, use:e.target.checked})}
                    className="w-4 h-4 rounded" />
                  <span className="text-gray-700 font-semibold">ì„ ìˆ˜ê¸ˆ ì ìš©</span>
                </label>
              </div>
              {advance.use && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <label className="text-xs text-gray-600 w-12">ë¹„ìœ¨</label>
                    <input type="number" value={advance.rate} min={1} max={100} step={5}
                      onChange={e => setAdvance({...advance, rate:Number(e.target.value)})}
                      className="w-20 px-2 py-1.5 border rounded text-sm text-right bg-gray-50" />
                    <span className="text-sm text-gray-500">%</span>
                  </div>
                  <div className="flex items-center gap-2 pt-2 border-t mt-2">
                    <label className="text-xs text-gray-600 w-12">ê¸ˆì•¡</label>
                    <span className="mono text-sm font-bold text-orange-600">{fmt.num(advanceAmt)}ì›</span>
                  </div>
                </div>
              )}
            </div>

            {/* ê²°ì¬ì ì§€ì • (ë“±ë¡ëœ ê²°ì¬ì ë“œë¡­ë‹¤ìš´) */}
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">ê²°ì¬ì ì§€ì • <span className="text-xs text-gray-400">(Phase2ì—ì„œ ì‹¤ì œ ë°œì†¡)</span></h3>
              <div className="space-y-2">
                <select value={approver} onChange={e => setApprover(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
                  <option value="">-- ê²°ì¬ì ì„ íƒ --</option>
                  {(storage.get('approvers') || []).filter(a => a.role === 'approver').map(a => (
                    <option key={a.id} value={a.email}>{a.name} ({a.email})</option>
                  ))}
                </select>
                {approver && (() => {
                  const sel = (storage.get('approvers')||[]).find(a => a.email === approver);
                  return sel ? (
                    <div className="bg-blue-50 border border-blue-200 rounded px-3 py-1.5 flex items-center gap-2">
                      <span className="text-blue-600 text-xs">âœ‰ï¸</span>
                      <span className="text-xs text-blue-700 font-semibold">{sel.name}</span>
                      <span className="text-xs text-blue-500 mono">{sel.email}</span>
                    </div>
                  ) : null;
                })()}
                {(storage.get('approvers') || []).filter(a => a.role === 'approver').length === 0 && (
                  <p className="text-xs text-red-500">âš ï¸ ë“±ë¡ëœ ê²°ì¬ìê°€ ì—†ìŠµë‹ˆë‹¤. ì •ë³´ê´€ë¦¬ â†’ ê²°ì¬ìê´€ë¦¬ì—ì„œ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”.</p>
                )}
                <p className="text-xs text-gray-400">ğŸ’¡ ê²°ì¬ ìš”ì²­ ì‹œ ì´ ì£¼ì†Œë¡œ ì´ë©”ì¼ ë°œì†¡</p>
              </div>
            </div>

            {/* í•©ê³„ */}
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">ê¸ˆì•¡ í•©ê³„</h3>
              <div className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">ë°œì£¼ê¸ˆì•¡</span>
                  <span className="mono font-semibold">{fmt.num(totalAmt)}ì›</span>
                </div>
                {advance.use && (
                  <>
                    <div className="flex justify-between text-sm">
                      <span className="text-orange-600">ì„ ìˆ˜ê¸ˆ ({advance.rate}%)</span>
                      <span className="mono font-semibold text-orange-600">{fmt.num(advanceAmt)}ì›</span>
                    </div>
                    <div className="flex justify-between text-sm border-t pt-2">
                      <span className="text-gray-600">ì”ì•¡</span>
                      <span className="mono font-semibold text-blue-600">{fmt.num(totalAmt - advanceAmt)}ì›</span>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* ì²¨ë¶€íŒŒì¼ (ì¸ë³´ì´ìŠ¤ / ê³„ì•½ì„œ) */}
          <div className="bg-white p-5 rounded-xl border shadow-sm">
            <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2">ì²¨ë¶€íŒŒì¼ <span className="text-xs text-gray-400 font-normal">(ê²°ì¬Â·ì†¡ê¸ˆ ìš”ì²­ ì´ë©”ì¼ì— ìë™ ì²¨ë¶€)</span></h3>
            <div className="grid grid-cols-2 gap-4">
              {/* ì¸ë³´ì´ìŠ¤ */}
              <div className="border-2 border-dashed border-gray-200 rounded-lg p-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-semibold text-gray-700">ğŸ“„ ì¸ë³´ì´ìŠ¤</span>
                  {attachments.invoice && (
                    <button onClick={() => setAttachments({...attachments, invoice: null, invoiceName: ''})}
                      className="text-red-400 hover:text-red-600 text-xs">âœ• ì œê±°</button>
                  )}
                </div>
                {attachments.invoice ? (
                  <div className="bg-green-50 border border-green-200 rounded px-3 py-2 flex items-center gap-2">
                    <span className="text-green-600 text-sm">âœ…</span>
                    <span className="text-xs text-green-700 truncate">{attachments.invoiceName}</span>
                  </div>
                ) : (
                  <label className="block cursor-pointer">
                    <div className="bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded px-3 py-2 text-center transition">
                      <p className="text-xs text-gray-500">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                    </div>
                    <input type="file" accept=".pdf" className="hidden" onChange={e => {
                      if (!e.target.files[0]) return;
                      const file = e.target.files[0];
                      const reader = new FileReader();
                      reader.onload = ev => setAttachments({...attachments, invoice: ev.target.result, invoiceName: file.name});
                      reader.readAsDataURL(file);
                      e.target.value = '';
                    }} />
                  </label>
                )}
              </div>

              {/* ê³„ì•½ì„œ */}
              <div className="border-2 border-dashed border-gray-200 rounded-lg p-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-semibold text-gray-700">ğŸ“„ ê³„ì•½ì„œ</span>
                  {attachments.contract && (
                    <button onClick={() => setAttachments({...attachments, contract: null, contractName: ''})}
                      className="text-red-400 hover:text-red-600 text-xs">âœ• ì œê±°</button>
                  )}
                </div>
                {attachments.contract ? (
                  <div className="bg-green-50 border border-green-200 rounded px-3 py-2 flex items-center gap-2">
                    <span className="text-green-600 text-sm">âœ…</span>
                    <span className="text-xs text-green-700 truncate">{attachments.contractName}</span>
                  </div>
                ) : (
                  <label className="block cursor-pointer">
                    <div className="bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded px-3 py-2 text-center transition">
                      <p className="text-xs text-gray-500">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                    </div>
                    <input type="file" accept=".pdf" className="hidden" onChange={e => {
                      if (!e.target.files[0]) return;
                      const file = e.target.files[0];
                      const reader = new FileReader();
                      reader.onload = ev => setAttachments({...attachments, contract: ev.target.result, contractName: file.name});
                      reader.readAsDataURL(file);
                      e.target.value = '';
                    }} />
                  </label>
                )}
              </div>
            </div>
          </div>

          {/* ì €ì¥ ë²„íŠ¼ */}
          <div className="flex justify-end gap-3">
            <button onClick={() => { setHeader(emptyHeader); setLines([{...emptyLine}]); setAdvance({use:false,rate:30}); setApprover(''); setAttachments({invoice:null,invoiceName:'',contract:null,contractName:''}); }}
              className="px-5 py-2 rounded-lg border text-sm text-gray-600 hover:bg-gray-100">ì´ˆê¸°í™”</button>
            <button onClick={handleSave}
              className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-lg font-semibold btn-primary">ë°œì£¼ ì €ì¥</button>
          </div>
        </div>
      );
    }

    // ========== ë°œì£¼ë‚´ì—­ ==========
    function PurchaseList() {
      const [purchases, setPurchases] = useState(storage.get('purchases') || []);
      const [selected, setSelected]   = useState(null); // ìƒì„¸ í´ë¦­ ê±´
      const vendors = storage.get('vendors') || [];

      const reload = () => setPurchases(storage.get('purchases') || []);

      // --- ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼ ---
      const updatePurchase = (id, patch) => {
        const list = (storage.get('purchases') || []).map(p =>
          p.id === id ? { ...p, ...patch } : p
        );
        storage.set('purchases', list);
        setPurchases(list);
        setSelected(list.find(p => p.id === id) || null);
      };

      // [ê²°ì¬ ìš”ì²­] â†’ Phase1: statusë§Œ ë³€ê²½ (Phase2ì—ì„œ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ + ì²¨ë¶€)
      const requestApproval = (p) => {
        if (!p.approver) { alert('ê²°ì¬ì ì´ë©”ì¼ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'); return; }
        updatePurchase(p.id, { approvalStatus: 'pending', approvalRequestDate: new Date().toISOString() });
        const att = [];
        if (p.attachments?.invoice) att.push('ì¸ë³´ì´ìŠ¤');
        if (p.attachments?.contract) att.push('ê³„ì•½ì„œ');
        alert('ê²°ì¬ ìš”ì²­ ì™„ë£Œ!' + (att.length ? '\nìë™ ì²¨ë¶€: ' + att.join(', ') : '\nâš ï¸ ì²¨ë¶€íŒŒì¼ ì—†ìŒ') + '\n(Phase2ì—ì„œ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡)');
      };

      // [ìŠ¹ë‚™] (Phase1 í…ŒìŠ¤íŠ¸ìš© â€” ì‹¤ì œë¡œëŠ” ê²°ì¬ìê°€ ì´ë©”ì¼ì—ì„œ í´ë¦­)
      const approveOrder = (p) => {
        updatePurchase(p.id, { approvalStatus: 'approved', approvalDate: new Date().toISOString() });
      };

      // [ë°˜ê¸°]
      const rejectOrder = (p, comment) => {
        updatePurchase(p.id, { approvalStatus: 'rejected', approvalDate: new Date().toISOString(), approvalComment: comment || 'ë°˜ê¸°' });
      };

      // [ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ìš”ì²­] â†’ Phase1: statusë§Œ ë³€ê²½ (Phase2ì—ì„œ íšŒê³„íŒ€ ì´ë©”ì¼ + ì²¨ë¶€)
      const requestPayment = (p) => {
        if (!p.advance || !p.advance.use) { alert('ì„ ìˆ˜ê¸ˆì´ ì ìš©ë˜ì§€ ì•Šì€ ê±´ì…ë‹ˆë‹¤'); return; }
        updatePurchase(p.id, { paymentStatus: 'requested', paymentRequestDate: new Date().toISOString() });
        const att = [];
        if (p.attachments?.invoice) att.push('ì¸ë³´ì´ìŠ¤');
        if (p.attachments?.contract) att.push('ê³„ì•½ì„œ');
        alert('ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ìš”ì²­ ì™„ë£Œ!\nê¸ˆì•¡: ' + fmt.num(p.advance.amount) + 'ì›' + (att.length ? '\nìë™ ì²¨ë¶€: ' + att.join(', ') : '\nâš ï¸ ì²¨ë¶€íŒŒì¼ ì—†ìŒ') + '\n(Phase2ì—ì„œ íšŒê³„íŒ€ ì´ë©”ì¼ ë°œì†¡)');
      };

      // [ì§€ê¸‰ì™„ë£Œ] (íšŒê³„íŒ€ ì²˜ë¦¬í›„ í‘œì‹œ â€” Phase1 í…ŒìŠ¤íŠ¸ìš©)
      const completePayment = (p) => {
        updatePurchase(p.id, { paymentStatus: 'completed', paymentCompleteDate: new Date().toISOString() });
      };

      // [ì”ê¸ˆ ì†¡ê¸ˆìš”ì²­] â†’ Phase1: statusë§Œ ë³€ê²½ (Phase2ì—ì„œ íšŒê³„íŒ€ ì´ë©”ì¼ + ì²¨ë¶€íŒŒì¼)
      const requestBalance = (p) => {
        updatePurchase(p.id, { balancePaymentStatus: 'requested', balanceRequestDate: new Date().toISOString() });
        const att = [];
        if (p.attachments?.invoice) att.push('ì¸ë³´ì´ìŠ¤');
        if (p.attachments?.contract) att.push('ê³„ì•½ì„œ');
        alert('ì”ê¸ˆ ì†¡ê¸ˆìš”ì²­ ì™„ë£Œ!\nê¸ˆì•¡: ' + fmt.num(p.totalAmt - p.advance.amount) + 'ì›' + (att.length ? '\nìë™ ì²¨ë¶€: ' + att.join(', ') : '') + '\n(Phase2ì—ì„œ íšŒê³„íŒ€ ì´ë©”ì¼ ë°œì†¡)');
      };

      // [ì”ê¸ˆ ì†¡ê¸ˆì™„ë£Œ] (íšŒê³„íŒ€ ì²˜ë¦¬í›„ í‘œì‹œ â€” Phase1 í…ŒìŠ¤íŠ¸ìš©)
      const completeBalance = (p) => {
        updatePurchase(p.id, { balancePaymentStatus: 'completed', balanceCompleteDate: new Date().toISOString() });
      };

      // --- ì—‘ì…€/PDF/í”„ë¦°íŠ¸ ê³µí†µ ë°ì´í„° ---
      const tableHeaders = ['ë°œì£¼ë²ˆí˜¸','ë°œì£¼ì¼','ì—…ì²´','ê°•ì¢…','ë°œì£¼ê¸ˆì•¡','ì„ ìˆ˜ê¸ˆì•¡','ì”ê¸ˆì•¡','ê²°ì¬ìƒíƒœ','ì„ ìˆ˜ê¸ˆ ì§€ê¸‰','ì”ê¸ˆ ì†¡ê¸ˆ','ì²¨ë¶€'];
      const tableRows = purchases.map(p => [
        p.id,
        fmt.date(p.date),
        (vendors.find(v => v.id === p.vendor) || {}).name || p.vendor,
        (storage.get('steeltypes')||[]).find(s => s.code === p.steeltype)?.name || p.steeltype || '-',
        fmt.num(p.totalAmt),
        p.advance?.use ? fmt.num(p.advance.amount) : '-',
        p.advance?.use ? fmt.num(p.totalAmt - p.advance.amount) : '-',
        { none:'ë“±ë¡ì™„ë£Œ', pending:'ê²°ì¬ëŒ€ê¸°', approved:'ìŠ¹ë‚™', rejected:'ë°˜ê¸°' }[p.approvalStatus] || '-',
        p.advance?.use ? ({ none:'-', requested:'ì§€ê¸‰ìš”ì²­', completed:'ì§€ê¸‰ì™„ë£Œ' }[p.paymentStatus] || '-') : '-',
        p.advance?.use ? ({ none:'-', requested:'ì†¡ê¸ˆìš”ì²­', completed:'ì†¡ê¸ˆì™„ë£Œ' }[p.balancePaymentStatus] || '-') : '-',
        [p.attachments?.invoice ? 'ì¸ë³´ì´ìŠ¤' : '', p.attachments?.contract ? 'ê³„ì•½ì„œ' : ''].filter(Boolean).join(', ') || 'ì—†ìŒ'
      ]);

      // --- ìƒíƒœ ë°°ì§€ ---
      const ApprovalBadge = ({status}) => {
        const map = { none:['bg-gray-100 text-gray-500','ë“±ë¡ì™„ë£Œ'], pending:['bg-yellow-100 text-yellow-700','ê²°ì¬ëŒ€ê¸°'], approved:['bg-green-100 text-green-700','ìŠ¹ë‚™'], rejected:['bg-red-100 text-red-600','ë°˜ê¸°'] };
        const [cls, lbl] = map[status] || ['bg-gray-100 text-gray-500', status];
        return <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${cls}`}>{lbl}</span>;
      };
      const PaymentBadge = ({status}) => {
        const map = { none:['bg-gray-100 text-gray-400','-'], requested:['bg-blue-100 text-blue-700','ì§€ê¸‰ìš”ì²­'], completed:['bg-green-100 text-green-700','ì§€ê¸‰ì™„ë£Œ'] };
        const [cls, lbl] = map[status] || ['bg-gray-100 text-gray-400', '-'];
        return <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${cls}`}>{lbl}</span>;
      };

      // ===== ìƒì„¸ ë·° =====
      if (selected) {
        const p = selected;
        const vendorName = (vendors.find(v => v.id === p.vendor) || {}).name || p.vendor;
        return (
          <div className="space-y-4">
            {/* í—¤ë” + ë°± ë²„íŠ¼ */}
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <button onClick={() => setSelected(null)} className="text-gray-500 hover:text-gray-700 text-sm">â† ëª©ë¡</button>
                <h1 className="text-xl font-bold text-gray-800 mono">{p.id}</h1>
                <ApprovalBadge status={p.approvalStatus} />
                {p.advance?.use && <PaymentBadge status={p.paymentStatus} />}
              </div>
              <div className="flex gap-2">
                <button onClick={() => printPage('ë°œì£¼ì„œ - '+p.id, ['í’ˆë²ˆ','í’ˆëª…','ê·œê²©','í”„ë¡œì íŠ¸','ìˆ˜ëŸ‰','ë‹¨ê°€','ê¸ˆì•¡'], p.lines.map(l => [l.itemCode,l.itemName,l.spec,'',fmt.num(l.qty),fmt.num(l.unitPrice),fmt.num(l.amount)]))}
                  className="px-3 py-1.5 rounded-lg border text-xs text-gray-600 hover:bg-gray-100">ğŸ–¨ï¸ í”„ë¦°íŠ¸</button>
                <button onClick={() => excelDown([...p.lines.map(l => [l.itemCode,l.itemName,l.spec,fmt.num(l.qty),fmt.num(l.unitPrice),fmt.num(l.amount)])], ['í’ˆë²ˆ','í’ˆëª…','ê·œê²©','ìˆ˜ëŸ‰','ë‹¨ê°€','ê¸ˆì•¡'], 'ë°œì£¼ì„œ_'+p.id)}
                  className="px-3 py-1.5 rounded-lg border text-xs text-green-700 hover:bg-green-50">ğŸ“Š ì—‘ì…€</button>
                <button onClick={() => pdfDown('ë°œì£¼ì„œ - '+p.id, ['í’ˆë²ˆ','í’ˆëª…','ê·œê²©','ìˆ˜ëŸ‰','ë‹¨ê°€','ê¸ˆì•¡'], p.lines.map(l => [l.itemCode,l.itemName,l.spec,String(l.qty),fmt.num(l.unitPrice),fmt.num(l.amount)]), 'ë°œì£¼ì„œ_'+p.id)}
                  className="px-3 py-1.5 rounded-lg border text-xs text-red-700 hover:bg-red-50">ğŸ“„ PDF</button>
              </div>
            </div>

            {/* ê¸°ë³¸ì •ë³´ */}
            <div className="bg-white p-5 rounded-xl border shadow-sm">
              <div className="grid grid-cols-4 gap-4 text-sm">
                <div><span className="text-gray-500">ë°œì£¼ì¼ì</span><p className="font-semibold">{fmt.date(p.date)}</p></div>
                <div><span className="text-gray-500">ì—…ì²´</span><p className="font-semibold">{vendorName}</p></div>
                <div><span className="text-gray-500">ê°•ì¢…êµ¬ë¶„</span><p className="font-semibold">{(storage.get('steeltypes')||[]).find(s=>s.code===p.steeltype)?.name || '-'}</p></div>
                <div><span className="text-gray-500">ë‚©í’ˆì¥ì†Œ</span><p className="font-semibold">{(storage.get('warehouses')||[]).find(w=>w.id===p.deliveryPlace)?.name || '-'}</p></div>
              </div>
            </div>

            {/* í’ˆëª©í–‰ */}
            <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    {['í’ˆë²ˆ','í’ˆëª…','ê·œê²©','í”„ë¡œì íŠ¸','T','W','L','ìˆ˜ëŸ‰','ë‹¨ê°€','ê¸ˆì•¡','ë¹„ê³ '].map(h => (
                      <th key={h} className="px-3 py-2 text-xs font-semibold text-gray-600 border-b">{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {p.lines.map((l,i) => (
                    <tr key={i} className="border-b">
                      <td className="px-3 py-2 mono text-blue-600 text-sm">{l.itemCode}</td>
                      <td className="px-3 py-2 text-sm font-semibold">{l.itemName}</td>
                      <td className="px-3 py-2 text-sm text-gray-500">{l.spec}</td>
                      <td className="px-3 py-2 text-sm text-gray-500">{(storage.get('projects')||[]).find(pr=>pr.id===l.project)?.name || '-'}</td>
                      <td className="px-3 py-2 text-sm text-right">{l.T || '-'}</td>
                      <td className="px-3 py-2 text-sm text-right">{l.W || '-'}</td>
                      <td className="px-3 py-2 text-sm text-right">{l.L || '-'}</td>
                      <td className="px-3 py-2 text-sm text-right mono">{fmt.num(l.qty)}</td>
                      <td className="px-3 py-2 text-sm text-right mono">{fmt.num(l.unitPrice)}</td>
                      <td className="px-3 py-2 text-sm text-right mono font-semibold text-blue-600">{fmt.num(l.amount)}</td>
                      <td className="px-3 py-2 text-sm text-gray-400">{l.notes || '-'}</td>
                    </tr>
                  ))}
                  <tr className="bg-gray-50 font-bold">
                    <td colSpan={9} className="px-3 py-2 text-sm text-right text-gray-600">í•©ê³„</td>
                    <td className="px-3 py-2 text-sm text-right mono text-blue-700">{fmt.num(p.totalAmt)}</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>

            {/* ê²°ì¬Â·ì§€ê¸‰Â·ì†¡ê¸ˆ ìƒíƒœ ì¹´ë“œ ì˜ì—­ */}
            {/* ROW 1: ì„ ìˆ˜ê¸ˆì •ë³´ + ê²°ì¬ìƒíƒœ + ì²¨ë¶€íŒŒì¼ */}
            <div className="grid grid-cols-3 gap-4">
              {/* ì„ ìˆ˜ê¸ˆ ì •ë³´ */}
              <div className="bg-white p-4 rounded-xl border shadow-sm">
                <h3 className="text-xs font-bold text-gray-600 mb-2 border-b pb-1.5">ì„ ìˆ˜ê¸ˆ ì •ë³´</h3>
                {p.advance?.use ? (
                  <div className="space-y-1 text-sm">
                    <div className="flex justify-between"><span className="text-gray-500">ë¹„ìœ¨</span><span className="font-semibold">{p.advance.rate}%</span></div>
                    <div className="flex justify-between"><span className="text-orange-600">ì„ ìˆ˜ê¸ˆ</span><span className="mono font-bold text-orange-600">{fmt.num(p.advance.amount)}ì›</span></div>
                    <div className="flex justify-between border-t pt-1 mt-1"><span className="text-blue-600">ì”ê¸ˆ</span><span className="mono font-bold text-blue-600">{fmt.num(p.totalAmt - p.advance.amount)}ì›</span></div>
                  </div>
                ) : <p className="text-xs text-gray-400">ì„ ìˆ˜ê¸ˆ ë¯¸ì ìš© â€” ì†¡ê¸ˆìš”ì²­ ë¶ˆí•„ìš”</p>}
              </div>

              {/* ê²°ì¬ ìƒíƒœ */}
              <div className="bg-white p-4 rounded-xl border shadow-sm">
                <h3 className="text-xs font-bold text-gray-600 mb-2 border-b pb-1.5 flex justify-between items-center">
                  <span>ê²°ì¬ ìƒíƒœ</span><ApprovalBadge status={p.approvalStatus} />
                </h3>
                <div className="text-xs text-gray-500 space-y-1">
                  {p.approver && <p>ê²°ì¬ì: {p.approver}</p>}
                  {p.approvalRequestDate && <p>ìš”ì²­ì¼: {fmt.date(p.approvalRequestDate)}</p>}
                  {p.approvalDate && <p>ì²˜ë¦¬ì¼: {fmt.date(p.approvalDate)}</p>}
                  {p.approvalComment && <p className="text-red-500 font-semibold">ë°˜ê¸° ì‚¬ìœ : {p.approvalComment}</p>}
                </div>
                <div className="mt-3 flex flex-wrap gap-1">
                  {p.approvalStatus === 'none' && (
                    <button onClick={() => requestApproval(p)} className="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs font-semibold">ê²°ì¬ ìš”ì²­</button>
                  )}
                  {p.approvalStatus === 'pending' && (
                    <>
                      <button onClick={() => approveOrder(p)} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold">ìŠ¹ë‚™ (í…ŒìŠ¤íŠ¸)</button>
                      <button onClick={() => { const c = prompt('ë°˜ê¸° ì‚¬ìœ :'); if(c !== null) rejectOrder(p, c); }}
                        className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold">ë°˜ê¸° (í…ŒìŠ¤íŠ¸)</button>
                    </>
                  )}
                </div>
              </div>

              {/* ì²¨ë¶€íŒŒì¼ */}
              <div className="bg-white p-4 rounded-xl border shadow-sm">
                <h3 className="text-xs font-bold text-gray-600 mb-2 border-b pb-1.5">ì²¨ë¶€íŒŒì¼</h3>
                <div className="space-y-2">
                  {p.attachments?.invoice ? (
                    <div className="flex items-center justify-between bg-green-50 border border-green-200 rounded px-2.5 py-1.5">
                      <span className="text-xs text-green-700">ğŸ“„ ì¸ë³´ì´ìŠ¤</span>
                      <button onClick={() => { const a = document.createElement('a'); a.href = p.attachments.invoice; a.download = p.attachments.invoiceName; a.click(); }}
                        className="text-blue-600 hover:text-blue-800 text-xs font-semibold">ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                  ) : <p className="text-xs text-gray-400">ì¸ë³´ì´ìŠ¤ ì²¨ë¶€ ì—†ìŒ</p>}
                  {p.attachments?.contract ? (
                    <div className="flex items-center justify-between bg-green-50 border border-green-200 rounded px-2.5 py-1.5">
                      <span className="text-xs text-green-700">ğŸ“„ ê³„ì•½ì„œ</span>
                      <button onClick={() => { const a = document.createElement('a'); a.href = p.attachments.contract; a.download = p.attachments.contractName; a.click(); }}
                        className="text-blue-600 hover:text-blue-800 text-xs font-semibold">ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                  ) : <p className="text-xs text-gray-400">ê³„ì•½ì„œ ì²¨ë¶€ ì—†ìŒ</p>}
                </div>
                {(p.attachments?.invoice || p.attachments?.contract) && (
                  <p className="text-xs text-gray-400 mt-2">ğŸ’¡ ê²°ì¬Â·ì§€ê¸‰Â·ì†¡ê¸ˆ ì´ë©”ì¼ì— ìë™ ì²¨ë¶€ (Phase2)</p>
                )}
              </div>
            </div>

            {/* ROW 2: ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ + ì”ê¸ˆ ì†¡ê¸ˆ (ì„ ìˆ˜ê¸ˆ ìˆëŠ” ê±´ë§Œ) */}
            {p.advance?.use && (
              <div className="grid grid-cols-2 gap-4">
                {/* ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ */}
                <div className={`p-4 rounded-xl border shadow-sm ${p.paymentStatus === 'completed' ? 'bg-orange-50 border-orange-200' : 'bg-white'}`}>
                  <h3 className="text-xs font-bold text-gray-600 mb-2 border-b pb-1.5 flex justify-between items-center">
                    <span>â‘  ì„ ìˆ˜ê¸ˆ ì§€ê¸‰</span><PaymentBadge status={p.paymentStatus} />
                  </h3>
                  <div className="text-sm">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-500">ì§€ê¸‰ ê¸ˆì•¡</span>
                      <span className="mono font-bold text-orange-600">{fmt.num(p.advance.amount)}ì›</span>
                    </div>
                  </div>
                  <div className="text-xs text-gray-500 space-y-0.5 mt-1">
                    {p.paymentRequestDate && <p>ìš”ì²­ì¼: {fmt.date(p.paymentRequestDate)}</p>}
                    {p.paymentCompleteDate && <p>ì™„ë£Œì¼: {fmt.date(p.paymentCompleteDate)}</p>}
                  </div>
                  <div className="mt-3 flex flex-wrap gap-1">
                    {p.approvalStatus === 'approved' && p.paymentStatus === 'none' && (
                      <button onClick={() => requestPayment(p)} className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold">ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ìš”ì²­</button>
                    )}
                    {p.paymentStatus === 'requested' && (
                      <button onClick={() => completePayment(p)} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold">ì§€ê¸‰ì™„ë£Œ (í…ŒìŠ¤íŠ¸)</button>
                    )}
                    {p.paymentStatus === 'completed' && <span className="text-xs text-orange-600 font-semibold">âœ… ì§€ê¸‰ ì™„ë£Œ</span>}
                  </div>
                </div>

                {/* ì”ê¸ˆ ì†¡ê¸ˆ */}
                <div className={`p-4 rounded-xl border shadow-sm ${p.paymentStatus !== 'completed' ? 'bg-gray-50 border-dashed opacity-60' : p.balancePaymentStatus === 'completed' ? 'bg-blue-50 border-blue-200' : 'bg-white'}`}>
                  <h3 className="text-xs font-bold text-gray-600 mb-2 border-b pb-1.5 flex justify-between items-center">
                    <span>â‘¡ ì”ê¸ˆ ì†¡ê¸ˆ</span>
                    {p.paymentStatus === 'completed' ? <PaymentBadge status={p.balancePaymentStatus} /> : <span className="text-xs text-gray-400 bg-gray-200 px-2 py-0.5 rounded-full">ëŒ€ê¸°ì¤‘</span>}
                  </h3>
                  <div className="text-sm">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-500">ì†¡ê¸ˆ ê¸ˆì•¡</span>
                      <span className="mono font-bold text-blue-600">{fmt.num(p.totalAmt - p.advance.amount)}ì›</span>
                    </div>
                  </div>
                  <div className="text-xs text-gray-500 space-y-0.5 mt-1">
                    {p.balanceRequestDate && <p>ìš”ì²­ì¼: {fmt.date(p.balanceRequestDate)}</p>}
                    {p.balanceCompleteDate && <p>ì™„ë£Œì¼: {fmt.date(p.balanceCompleteDate)}</p>}
                    {p.paymentStatus !== 'completed' && <p className="text-gray-400 italic">ì„ ìˆ˜ê¸ˆ ì§€ê¸‰ ì™„ë£Œ í›„ í™œì„±í™”</p>}
                  </div>
                  <div className="mt-3 flex flex-wrap gap-1">
                    {p.paymentStatus === 'completed' && p.balancePaymentStatus === 'none' && (
                      <button onClick={() => requestBalance(p)} className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-semibold">ì”ê¸ˆ ì†¡ê¸ˆìš”ì²­</button>
                    )}
                    {p.balancePaymentStatus === 'requested' && (
                      <button onClick={() => completeBalance(p)} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold">ì†¡ê¸ˆì™„ë£Œ (í…ŒìŠ¤íŠ¸)</button>
                    )}
                    {p.balancePaymentStatus === 'completed' && <span className="text-xs text-blue-600 font-semibold">âœ… ì†¡ê¸ˆ ì™„ë£Œ</span>}
                  </div>
                </div>
              </div>
            )}

            {/* ìˆ˜ì •/ì‚­ì œ */}
            <div className="flex justify-end gap-2">
              <button onClick={() => {
                const list = (storage.get('purchases')||[]).filter(x => x.id !== p.id);
                storage.set('purchases', list);
                setPurchases(list); setSelected(null);
              }} className="px-4 py-1.5 rounded-lg border text-xs text-red-600 hover:bg-red-50">ì‚­ì œ</button>
            </div>
          </div>
        );
      }

      // ===== ë¦¬ìŠ¤íŠ¸ ë·° =====
      return (
        <div className="space-y-5">
          <Toolbar
            title="ë°œì£¼ë‚´ì—­"
            subtitle="ë°œì£¼ ëª©ë¡ ì¡°íšŒ ë° ê²°ì¬Â·ì§€ê¸‰ ê´€ë¦¬"
            onPrint={() => printPage('ë°œì£¼ë‚´ì—­', tableHeaders, tableRows)}
            onExcelDown={() => excelDown(tableRows, tableHeaders, 'ë°œì£¼ë‚´ì—­')}
            onPdfDown={() => pdfDown('ë°œì£¼ë‚´ì—­', tableHeaders, tableRows, 'ë°œì£¼ë‚´ì—­')}
            onExcelUpload={() => alert('ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤')}
          />

          <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  {['ë°œì£¼ë²ˆí˜¸','ë°œì£¼ì¼','ì—…ì²´','ê°•ì¢…','ë°œì£¼ê¸ˆì•¡','ì„ ìˆ˜ê¸ˆ','ì”ê¸ˆ','ê²°ì¬','ì„ ìˆ˜ê¸ˆ ì§€ê¸‰','ì”ê¸ˆ ì†¡ê¸ˆ','ì²¨ë¶€','ì‘ì—…'].map(h => (
                    <th key={h} className="px-3 py-3 text-xs font-semibold text-gray-600 border-b text-left whitespace-nowrap">{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {purchases.length === 0 && (
                  <tr><td colSpan={12} className="text-center py-10 text-gray-400 text-sm">ë°œì£¼ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë°œì£¼ë“±ë¡ì„ ì§„í–‰í•˜ì„¸ìš”.</td></tr>
                )}
                {purchases.map(p => (
                  <tr key={p.id} className="border-b hover:bg-gray-50 cursor-pointer" onClick={() => setSelected(p)}>
                    <td className="px-3 py-3 mono text-blue-600 text-sm font-semibold whitespace-nowrap">{p.id}</td>
                    <td className="px-3 py-3 text-sm whitespace-nowrap">{fmt.date(p.date)}</td>
                    <td className="px-3 py-3 text-sm">{(vendors.find(v=>v.id===p.vendor)||{}).name || p.vendor}</td>
                    <td className="px-3 py-3 text-sm">{(storage.get('steeltypes')||[]).find(s=>s.code===p.steeltype)?.name || '-'}</td>
                    <td className="px-3 py-3 text-sm text-right mono font-semibold whitespace-nowrap">{fmt.num(p.totalAmt)}</td>
                    <td className="px-3 py-3 text-sm text-right mono text-orange-600 whitespace-nowrap">{p.advance?.use ? fmt.num(p.advance.amount) : <span className="text-gray-300">-</span>}</td>
                    <td className="px-3 py-3 text-sm text-right mono text-blue-600 whitespace-nowrap">{p.advance?.use ? fmt.num(p.totalAmt - p.advance.amount) : <span className="text-gray-300">-</span>}</td>
                    <td className="px-3 py-3"><ApprovalBadge status={p.approvalStatus} /></td>
                    <td className="px-3 py-3">{p.advance?.use ? <PaymentBadge status={p.paymentStatus} /> : <span className="text-xs text-gray-300">-</span>}</td>
                    <td className="px-3 py-3">{p.advance?.use ? <PaymentBadge status={p.balancePaymentStatus || 'none'} /> : <span className="text-xs text-gray-300">-</span>}</td>
                    <td className="px-3 py-3 text-xs">
                      {p.attachments?.invoice && <span className="inline-block bg-green-100 text-green-700 px-1.5 py-0.5 rounded mr-1">ì¸ë³´ì´ìŠ¤</span>}
                      {p.attachments?.contract && <span className="inline-block bg-green-100 text-green-700 px-1.5 py-0.5 rounded">ê³„ì•½ì„œ</span>}
                      {!p.attachments?.invoice && !p.attachments?.contract && <span className="text-gray-300">-</span>}
                    </td>
                    <td className="px-3 py-3" onClick={e => e.stopPropagation()}>
                      <button onClick={() => setSelected(p)} className="text-blue-600 hover:text-blue-800 text-xs mr-2">ìƒì„¸</button>
                      <button onClick={() => {
                        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                        const list = (storage.get('purchases')||[]).filter(x => x.id !== p.id);
                        storage.set('purchases', list); setPurchases(list);
                      }} className="text-red-500 hover:text-red-700 text-xs">ì‚­ì œ</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }
    function IncomingCreate() { return <ComingSoon viewId="incoming-create" title="ì…ê³ ë“±ë¡" />; }
    function IncomingList() { return <ComingSoon viewId="incoming-list" title="ì…ê³ ë‚´ì—­" />; }
    function OutgoingCreate() { return <ComingSoon viewId="outgoing-create" title="ì¶œê³ ë“±ë¡" />; }
    function OutgoingList() { return <ComingSoon viewId="outgoing-list" title="ì¶œê³ ë‚´ì—­" />; }
    function TransferCreate() { return <ComingSoon viewId="transfer-create" title="ì´ë™ë“±ë¡" />; }
    function TransferList() { return <ComingSoon viewId="transfer-list" title="ì´ë™ë‚´ì—­" />; }
    function StockCurrent() { return <ComingSoon viewId="stock-current" title="ì¬ê³ í˜„í™©" />; }
    function StockByItem() { return <ComingSoon viewId="stock-byitem" title="í’ˆëª©ë³„ ì¬ê³ " />; }
    function StockByWarehouse() { return <ComingSoon viewId="stock-bywarehouse" title="ì°½ê³ ë³„ ì¬ê³ " />; }
    function StockByProject() { return <ComingSoon viewId="stock-byproject" title="í”„ë¡œì íŠ¸ë³„ ì¬ê³ " />; }
    function ReportInOut() { return <ComingSoon viewId="report-inout" title="ì…ì¶œê³  í˜„í™©" />; }
    function ReportProject() { return <ComingSoon viewId="report-project" title="í”„ë¡œì íŠ¸ë³„ ì§‘ê³„" />; }
    function ReportAnalysis() { return <ComingSoon viewId="report-analysis" title="ì¬ê³  ë¶„ì„" />; }

    function ComingSoon({ viewId, title }) {
      return (
        <div className="bg-white p-12 rounded-xl border text-center">
          <div className="text-6xl mb-4">ğŸš§</div>
          <h2 className="text-2xl font-bold text-gray-800 mb-2">{title || viewId}</h2>
          <p className="text-gray-500">ì´ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤</p>
          <p className="text-sm text-gray-400 mt-2 mono">View ID: {viewId}</p>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
